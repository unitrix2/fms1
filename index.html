<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NCR LDCE Exam Portal</title>
    
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>

    <style>
        :root { 
            --primary: #b71c1c; 
            --primary-dark: #7f0000;
            --primary-light: #ffcdd2;
            --secondary: #eceff1; 
            --text: #263238; 
            --correct: #2e7d32; 
            --wrong: #c62828; 
            --warning: #ff8f00; 
            --skipped: #78909c;
            --header-bg: #fff;
        }
        
        body { font-family: 'Segoe UI', 'Roboto', sans-serif; margin: 0; background: var(--secondary); color: var(--text); display: flex; flex-direction: column; height: 100vh; overflow: hidden; }

        /* --- 1. LOGIN PAGE (ORIGINAL UI) --- */
        #login-page { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: radial-gradient(circle at center, #0d47a1 0%, #000000 100%); display: flex; flex-direction: column; justify-content: center; align-items: center; z-index: 10000; overflow: hidden; }
        #login-page::before { content: ''; position: absolute; width: 100%; height: 100%; background-image: radial-gradient(white 1px, transparent 1px); background-size: 50px 50px; opacity: 0.1; animation: moveStars 100s linear infinite; }
        @keyframes moveStars { from { transform: translateY(0); } to { transform: translateY(-1000px); } }

        .login-card { background: rgba(255, 255, 255, 0.1); backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px); padding: 20px 40px 40px 40px; border-radius: 20px; box-shadow: 0 25px 50px rgba(0,0,0,0.5), inset 0 0 0 1px rgba(255,255,255,0.1); width: 85%; max-width: 380px; text-align: center; border: 1px solid rgba(255, 255, 255, 0.2); position: relative; display: flex; flex-direction: column; align-items: center; margin-top: 60px; }
        .logo-wrapper { position: relative; width: 200px; height: 200px; margin-top: -120px; margin-bottom: 10px; display: flex; justify-content: center; align-items: center; }
        .central-logo { width: 90px; height: 90px; background: white; border-radius: 50%; padding: 5px; box-shadow: 0 0 30px rgba(255, 255, 255, 0.8), 0 0 10px var(--primary); z-index: 2; position: absolute; border: 3px solid #fff; object-fit: contain; }
        .rotating-svg { position: absolute; width: 100%; height: 100%; animation: spinText 20s linear infinite; z-index: 1; filter: drop-shadow(0px 2px 3px rgba(0,0,0,0.5)); }
        .rotating-svg text { font-family: 'Arial', sans-serif; font-size: 14px; font-weight: 900; letter-spacing: 2px; fill: #ffffff; text-transform: uppercase; }
        @keyframes spinText { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }

        .input-group { width: 100%; margin-bottom: 15px; }
        .input-group input { width: 100%; padding: 12px 15px; background: rgba(255,255,255,0.9); border: none; border-radius: 8px; font-size: 0.95rem; color: #333; box-sizing: border-box; }
        .login-btn { width: 100%; padding: 12px; background: linear-gradient(90deg, #d32f2f, #b71c1c); color: white; border: none; border-radius: 50px; font-size: 1rem; font-weight: 700; cursor: pointer; transition: 0.3s; text-transform: uppercase; }
        .login-btn:hover { transform: scale(1.02); }
        .google-btn { width: 100%; padding: 12px; background: white; color: #333; border: none; border-radius: 50px; font-size: 0.95rem; font-weight: 700; display: flex; align-items: center; justify-content: center; gap: 10px; cursor: pointer; margin-top: 10px; }
        .error-message { color: #ffeb3b; font-size: 0.85rem; margin-top: 10px; display: none; }

        /* --- 2. MAIN APP UI (ORIGINAL LAYOUT) --- */
        #app-content { display: none; height: 100%; flex-direction: column; }
        
        header { background: var(--header-bg); padding: 10px 20px; display: flex; justify-content: space-between; align-items: center; flex-shrink: 0; box-shadow: 0 4px 12px rgba(0,0,0,0.08); border-bottom: 3px solid var(--primary); }
        .header-left { display: flex; align-items: center; gap: 15px; }
        .railway-logo { width: 45px; height: 45px; background: url('https://images.seeklogo.com/logo-png/31/1/indian-railways-logo-png_seeklogo-310214.png') no-repeat center center; background-size: contain; }
        .title-group h2 { margin: 0; font-size: 1.3rem; color: var(--primary); font-weight: 700; }
        .title-group p { margin: 0; font-size: 0.75rem; color: #666; font-weight: 500; }
        
        .header-controls { display: flex; align-items: center; gap: 15px; }
        .logout-btn { background: #ffebee; border: 1px solid #ef9a9a; color: #c62828; padding: 5px 10px; border-radius: 5px; cursor: pointer; font-size: 0.8rem; font-weight: bold; }

        /* DASHBOARD (TEST SELECTION) */
        #dashboard-view { padding: 20px; overflow-y: auto; height: 100%; display: none; }
        .filter-container { margin-bottom: 20px; display: none; /* Hidden by default */ } 
        .custom-select { padding: 10px; border-radius: 5px; border: 1px solid #ccc; font-size: 1rem; width: 100%; max-width: 300px; }
        
        .test-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 15px; }
        .test-card { background: white; padding: 20px; border-radius: 10px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); border-left: 5px solid var(--primary); cursor: pointer; transition: 0.2s; display: flex; justify-content: space-between; align-items: center; }
        .test-card:hover { transform: translateY(-3px); box-shadow: 0 5px 15px rgba(0,0,0,0.15); }
        .test-name { font-weight: 600; color: #333; }
        .admin-btn { background: #333; color: white; border: none; padding: 5px 10px; border-radius: 4px; font-size: 0.75rem; margin-left: 10px; cursor: pointer; }

        /* QUIZ INTERFACE (ORIGINAL) */
        #quiz-view { display: none; height: 100%; padding: 15px; gap: 15px; }
        .q-area { flex: 3; background: white; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); overflow: hidden; display: flex; flex-direction: column; }
        .q-header { padding: 15px 25px; background: #f8f9fa; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; font-weight: bold; color: var(--primary); }
        .q-scroll-area { padding: 25px; overflow-y: auto; flex: 1; }
        .q-text { font-size: 1.2rem; font-weight: 600; margin-bottom: 10px; color: #263238; }
        .q-hindi { font-size: 1.1rem; margin-bottom: 20px; color: #546e7a; font-family: 'Nirmala UI', sans-serif; }
        .options label { display: flex; align-items: flex-start; padding: 12px; margin-bottom: 10px; border: 2px solid #e0e0e0; border-radius: 8px; cursor: pointer; transition: 0.2s; }
        .options label:hover { background: #fafafa; border-color: var(--primary); }
        .options input { margin-right: 15px; margin-top: 4px; transform: scale(1.3); accent-color: var(--primary); }
        
        .footer { padding: 15px 25px; display: flex; justify-content: space-between; border-top: 1px solid #eee; background: #fff; }
        .btn { padding: 10px 25px; border: none; border-radius: 6px; cursor: pointer; font-weight: 700; color: white; text-transform: uppercase; }
        .prev { background: #78909c; } .next { background: var(--primary); } .sub { background: var(--correct); }

        .sidebar { flex: 1; background: white; padding: 20px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); overflow-y: auto; max-width: 320px; border-top: 5px solid var(--primary); }
        .grid { display: grid; grid-template-columns: repeat(5, 1fr); gap: 10px; margin-top: 15px; }
        .p-btn { padding: 8px 0; background: #fff; border: 1px solid #cfd8dc; border-radius: 6px; cursor: pointer; text-align: center; font-size: 0.9rem; font-weight: 600; }
        .p-btn.done { background: var(--primary); color: white; border-color: var(--primary); }
        .p-btn.curr { border: 2px solid var(--warning); transform: scale(1.1); }

        /* LOADING SPINNER */
        #loader { position: fixed; top:0; left:0; width:100%; height:100%; background:rgba(255,255,255,0.9); z-index:9999; display:none; justify-content:center; align-items:center; }
        .spinner { width: 40px; height: 40px; border: 4px solid #eee; border-top: 4px solid var(--primary); border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* PRINT STYLE (Hidden normally) */
        @media print {
            body * { visibility: hidden; }
            #printable-area, #printable-area * { visibility: visible; }
            #printable-area { position: absolute; left: 0; top: 0; width: 100%; }
            .print-q { margin-bottom: 20px; border-bottom: 1px dashed #ccc; padding-bottom: 10px; break-inside: avoid; }
            .print-head { text-align: center; border-bottom: 2px solid black; margin-bottom: 20px; }
            .print-opt { display: grid; grid-template-columns: 1fr 1fr; margin-top: 10px; font-size: 0.9rem; }
            .print-key { break-before: page; }
        }
    </style>
</head>
<body>

<div id="loader"><div class="spinner"></div></div>

<div id="login-page">
    <div class="login-card">
        <div class="logo-wrapper">
            <svg class="rotating-svg" viewBox="0 0 300 300">
                <defs><path id="circlePath" d="M 150, 150 m -120, 0 a 120,120 0 1,1 240,0 a 120,120 0 1,1 -240,0" /></defs>
                <text><textPath xlink:href="#circlePath" startOffset="50%" text-anchor="middle">NORTH CENTRAL RAILWAY ‚Ä¢ EXAM PORTAL ‚Ä¢ SECURE SYSTEM ‚Ä¢</textPath></text>
            </svg>
            <img src="https://images.seeklogo.com/logo-png/31/1/indian-railways-logo-png_seeklogo-310214.png" class="central-logo">
        </div>
        <h2 style="color:white; margin:0 0 20px 0;">Sign In</h2>
        <div class="input-group"><input type="text" id="username" placeholder="Username / PF Number"></div>
        <div class="input-group"><input type="password" id="password" placeholder="Password"></div>
        <button class="login-btn" onclick="manualLogin()">Login</button>
        <div style="color:white; margin:10px 0; font-size:0.8rem;">OR</div>
        <button class="google-btn" onclick="googleLogin()">
            <img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg" width="20"> Sign in with Google
        </button>
        <div id="login-error" class="error-message"></div>
    </div>
</div>

<div id="app-content">
    <header>
        <div class="header-left">
            <div class="railway-logo"></div>
            <div class="title-group">
                <h2 id="header-title">LDCE Exam Portal</h2>
                <p>Departmental Examination</p>
            </div>
        </div>
        <div class="header-controls">
            <span id="user-display" style="font-weight:600; color:#555;">User</span>
            <button class="logout-btn" onclick="logout()">Logout</button>
        </div>
    </header>

    <div id="dashboard-view">
        <div id="filter-container" class="filter-container">
            <label style="font-weight:bold; display:block; margin-bottom:5px;">Select Category:</label>
            <select id="category-select" class="custom-select" onchange="fetchTests(this.value)">
                <option value="">Select...</option>
                </select>
        </div>
        <h3 style="margin-top:0; color:var(--primary); border-bottom:2px solid #eee; padding-bottom:10px;">Available Tests</h3>
        <div id="test-grid" class="test-grid"></div>
    </div>

    <div id="quiz-view">
        <div class="q-area">
            <div class="q-header">
                <span id="active-test-name">Test Name</span>
                <span id="timer">00:00</span>
            </div>
            <div class="q-scroll-area">
                <div id="q-content"></div>
            </div>
            <div class="footer">
                <button class="btn prev" onclick="nav(-1)">Previous</button>
                <button class="btn sub" onclick="submitTest()">Submit</button>
                <button class="btn next" onclick="nav(1)">Next</button>
            </div>
        </div>
        <div class="sidebar">
            <h3 style="margin-top:0; border-bottom:2px solid #eee; padding-bottom:10px; color:var(--primary);">Palette</h3>
            <div class="grid" id="palette"></div>
        </div>
    </div>
</div>

<div id="printable-area"></div>

<script>
    // --- CONFIGURATION (EDIT THIS) ---
    const GH_USERNAME = 'unitrix2';
    const GH_REPO = 'fms1';
    
    // FIREBASE CONFIG
    const firebaseConfig = {
        apiKey: "AIzaSyCxCLczt1L01qr3DmdvAv_EU3IsWhgxs0w",
        authDomain: "fms1-39dca.firebaseapp.com",
        projectId: "fms1-39dca",
        storageBucket: "fms1-39dca.firebasestorage.app",
        messagingSenderId: "46968102286",
        appId: "1:46968102286:web:452d87de53dfcc2028d8df"
    };
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const provider = new firebase.auth.GoogleAuthProvider();

    // --- STATE ---
    let currentUser = null;
    let currentQuestions = [];
    let answers = {};
    let qIdx = 0;
    let timerInt;
    let time = 0;

    // --- AUTHENTICATION ---
    function googleLogin() {
        auth.signInWithPopup(provider).then(res => validateUser(res.user.email, 'google'))
            .catch(e => showError(e.message));
    }

    async function manualLogin() {
        const u = document.getElementById('username').value;
        const p = document.getElementById('password').value;
        try {
            const res = await fetch('users.json');
            if(!res.ok) throw new Error("Users file missing");
            const users = await res.json();
            const valid = users.find(usr => usr.username === u && usr.password === p);
            if(valid) validateUser(valid, 'manual');
            else showError("Invalid Credentials");
        } catch(e) { showError(e.message); }
    }

    async function validateUser(identifier, type) {
        let userRole = [];
        let name = "User";
        
        if(type === 'google') {
            const res = await fetch('allowed_users.json');
            const allowed = await res.json();
            const userObj = allowed.find(a => a.email.toLowerCase() === identifier.toLowerCase());
            if(userObj) {
                userRole = userObj.access; // e.g. ["je", "tech-iii"]
                name = identifier.split('@')[0];
            } else {
                auth.signOut(); showError("Access Denied"); return;
            }
        } else {
            userRole = identifier.access;
            name = identifier.name;
        }

        currentUser = { name: name, roles: userRole };
        sessionStorage.setItem('user', JSON.stringify(currentUser));
        initApp();
    }

    function showError(msg) {
        const el = document.getElementById('login-error');
        el.innerText = msg; el.style.display = 'block';
    }

    // --- APP INITIALIZATION ---
    function initApp() {
        document.getElementById('login-page').style.display = 'none';
        document.getElementById('app-content').style.display = 'flex';
        document.getElementById('dashboard-view').style.display = 'block';
        document.getElementById('user-display').innerText = currentUser.name;

        // 1. Set Header Text based on Roles
        let headerTxt = "LDCE Exam Portal";
        const roles = currentUser.roles.map(r => r.toUpperCase());
        
        if (roles.includes("ADMIN")) {
            headerTxt = "LDCE ADMIN PORTAL";
        } else if (roles.length > 0) {
            headerTxt = `LDCE ${roles.join(' / ')} (C&W) Mock Test`;
        }
        document.getElementById('header-title').innerText = headerTxt;

        // 2. Setup Category Dropdown or Direct Load
        const filterCont = document.getElementById('filter-container');
        const catSelect = document.getElementById('category-select');
        
        // Clear previous options
        catSelect.innerHTML = '<option value="">Select Category...</option>';

        if (roles.includes("ADMIN")) {
            // Admin sees all folders
            filterCont.style.display = 'block';
            ['tech-iii', 'je', 'adme'].forEach(r => {
                catSelect.innerHTML += `<option value="${r}">${r.toUpperCase()}</option>`;
            });
        } else if (roles.length > 1) {
            // Multiple permissions -> Show dropdown
            filterCont.style.display = 'block';
            currentUser.roles.forEach(r => {
                catSelect.innerHTML += `<option value="${r}">${r.toUpperCase()}</option>`;
            });
        } else if (roles.length === 1) {
            // Single permission -> Load directly
            fetchTests(currentUser.roles[0]);
        }
    }

    // --- FETCH TESTS FROM GITHUB FOLDERS ---
    async function fetchTests(category) {
        if(!category) return;
        const grid = document.getElementById('test-grid');
        grid.innerHTML = '<p>Loading tests...</p>';
        
        try {
            // Fetch from specific folder: tests/{category}
            const res = await fetch(`https://api.github.com/repos/${GH_USERNAME}/${GH_REPO}/contents/tests/${category}`);
            
            if(!res.ok) throw new Error("Folder not found or empty");
            
            const files = await res.json();
            grid.innerHTML = '';

            files.filter(f => f.name.endsWith('.json')).forEach(f => {
                const name = f.name.replace('.json', '').replace(/_/g, ' ').toUpperCase();
                const card = document.createElement('div');
                card.className = 'test-card';
                
                // Card Content
                let html = `<div class="test-name">${name}</div>`;
                html += `<div>`;
                
                // Admin Print Button
                if(currentUser.roles.includes('admin')) {
                    html += `<button class="admin-btn" onclick="printBooklet('${f.download_url}', '${name}'); event.stopPropagation();">üñ®Ô∏è Print</button>`;
                }
                
                html += `</div>`; // End controls
                
                card.innerHTML = html;
                card.onclick = () => startTest(f.download_url, name);
                grid.appendChild(card);
            });

            if(grid.innerHTML === '') grid.innerHTML = '<p>No tests found in this category.</p>';

        } catch(e) {
            grid.innerHTML = `<p style="color:red">Error loading tests: ${e.message}</p>`;
        }
    }

    // --- QUIZ LOGIC (UNCHANGED UI) ---
    async function startTest(url, name) {
        document.getElementById('loader').style.display = 'flex';
        try {
            const res = await fetch(url);
            currentQuestions = await res.json();
            
            // Switch View
            document.getElementById('dashboard-view').style.display = 'none';
            document.getElementById('quiz-view').style.display = 'flex';
            document.getElementById('active-test-name').innerText = name;
            
            // Reset State
            qIdx = 0;
            answers = {};
            time = 0;
            renderQuestion();
            renderPalette();
            
            // Timer
            clearInterval(timerInt);
            timerInt = setInterval(() => {
                time++;
                const m = Math.floor(time / 60).toString().padStart(2, '0');
                const s = (time % 60).toString().padStart(2, '0');
                document.getElementById('timer').innerText = `${m}:${s}`;
            }, 1000);

        } catch(e) {
            alert("Failed to load test. Please check internet.");
        } finally {
            document.getElementById('loader').style.display = 'none';
        }
    }

    function renderQuestion() {
        if(!currentQuestions.length) return;
        const q = currentQuestions[qIdx];
        const container = document.getElementById('q-content');
        
        let html = `<div class="q-text">Q${qIdx+1}. ${q.q}</div>`;
        if(q.h) html += `<div class="q-hindi">${q.h}</div>`;
        
        html += `<div class="options">`;
        q.o.forEach((opt, i) => {
            const checked = answers[qIdx] === i ? 'checked' : '';
            html += `<label><input type="radio" name="opt" onclick="saveAnswer(${i})" ${checked}> ${opt}</label>`;
        });
        html += `</div>`;
        
        container.innerHTML = html;
        updatePalette();
    }

    function saveAnswer(optIdx) {
        answers[qIdx] = optIdx;
        updatePalette();
    }

    function nav(dir) {
        if (qIdx + dir >= 0 && qIdx + dir < currentQuestions.length) {
            qIdx += dir;
            renderQuestion();
        }
    }

    function renderPalette() {
        const p = document.getElementById('palette');
        p.innerHTML = '';
        currentQuestions.forEach((_, i) => {
            const btn = document.createElement('div');
            btn.className = 'p-btn';
            btn.innerText = i + 1;
            btn.id = `pal-${i}`;
            btn.onclick = () => { qIdx = i; renderQuestion(); };
            p.appendChild(btn);
        });
        updatePalette();
    }

    function updatePalette() {
        for(let i=0; i<currentQuestions.length; i++) {
            const el = document.getElementById(`pal-${i}`);
            el.className = 'p-btn';
            if(answers[i] !== undefined) el.classList.add('done');
            if(i === qIdx) el.classList.add('curr');
        }
    }

    function submitTest() {
        if(confirm("Submit Test?")) {
            clearInterval(timerInt);
            // Simple Alert Score (As per instruction to not add complex UI)
            let score = 0;
            currentQuestions.forEach((q, i) => { if(answers[i] === q.c) score++; });
            alert(`Test Submitted!\nScore: ${score} / ${currentQuestions.length}`);
            location.reload();
        }
    }

    // --- ADMIN: PRINT BOOKLET FUNCTION ---
    async function printBooklet(url, title) {
        document.getElementById('loader').style.display = 'flex';
        try {
            const res = await fetch(url);
            const data = await res.json();
            
            let html = `<div class="print-head"><h1>${title}</h1><p>Offline Booklet - ${data.length} Questions</p></div>`;
            let key = `<div class="print-key"><h2 style="text-align:center">Answer Key</h2><div style="display:grid; grid-template-columns:repeat(5,1fr); font-size:0.8rem; gap:10px;">`;

            data.forEach((q, i) => {
                // Question Block
                html += `<div class="print-q">
                    <div style="font-weight:bold; margin-bottom:5px;">Q${i+1}. ${q.q}</div>
                    ${q.h ? `<div style="font-family:'Nirmala UI'; font-size:0.95rem; margin-bottom:5px;">${q.h}</div>` : ''}
                    <div class="print-opt">
                        ${q.o.map((opt, idx) => `<div>(${String.fromCharCode(65+idx)}) ${opt}</div>`).join('')}
                    </div>
                </div>`;
                
                // Answer Key Block
                key += `<div>${i+1}. <b>${String.fromCharCode(65+q.c)}</b></div>`;
            });
            
            key += `</div></div>`;
            
            const area = document.getElementById('printable-area');
            area.innerHTML = html + key;
            
            setTimeout(() => {
                window.print();
                area.innerHTML = ''; // Clean up
                document.getElementById('loader').style.display = 'none';
            }, 1000);

        } catch(e) {
            alert("Error generating PDF");
            document.getElementById('loader').style.display = 'none';
        }
    }

    function logout() {
        sessionStorage.clear();
        auth.signOut();
        location.reload();
    }

    // Session Check
    if(sessionStorage.getItem('user')) {
        currentUser = JSON.parse(sessionStorage.getItem('user'));
        initApp();
    }
</script>

</body>
</html>
