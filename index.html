<!DOCTYPE html>
<html lang="en" data-theme="dark">
<head>
  <meta charset="UTF-8" />
  <title>Contract Management Cell ‚Äì Digital File System</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <!-- Tailwind CDN -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            iridescent1: "#8EC5FC",
            iridescent2: "#E0C3FC",
          },
          boxShadow: {
            glass: "0 25px 50px -12px rgba(0, 0, 0, 0.45)",
          },
        },
      },
    };
  </script>
  <style>
    body {
      min-height: 100vh;
      background: radial-gradient(circle at 0% 0%, #8ec5fc 0, transparent 40%),
                  radial-gradient(circle at 100% 0%, #e0c3fc 0, transparent 45%),
                  radial-gradient(circle at 100% 100%, #f9f871 0, transparent 40%),
                  radial-gradient(circle at 0% 100%, #ff9a9e 0, transparent 45%);
      background-color: #050816;
    }
    .glass {
      backdrop-filter: blur(18px);
      background: linear-gradient(135deg, rgba(255,255,255,0.16), rgba(255,255,255,0.05));
      border: 1px solid rgba(255,255,255,0.25);
    }
    .glass-strong {
      backdrop-filter: blur(24px);
      background: linear-gradient(135deg, rgba(255,255,255,0.25), rgba(255,255,255,0.06));
      border: 1px solid rgba(255,255,255,0.45);
    }
    .iridescent-border {
      border-image: linear-gradient(135deg, #8ec5fc, #e0c3fc, #f9f871, #ff9a9e) 1;
      border-width: 2px;
      border-style: solid;
    }
    .file-tag-pink { border-left: 4px solid #ff9aeb; }
    .file-tag-brown { border-left: 4px solid #8b5a2b; }
    .file-tag-white { border-left: 4px solid #f5f5f5; }
    .slide-in {
      animation: slide-in 0.3s ease-out forwards;
    }
    @keyframes slide-in {
      from { transform: translateX(100%); opacity: 0; }
      to { transform: translateX(0); opacity: 1; }
    }
  </style>
</head>
<body class="text-slate-100">
  <div id="app"></div>

  <script>
    /*************** CONFIG ‚Äì SABSE UPAR YAHAN WORKER URL SET KARO **************/
    let WORKER_URL = localStorage.getItem("workerUrl") || "https://fms1.clickworld.workers.dev";
    /*****************************************************************************/

    const app = document.getElementById("app");

    let state = {
      token: localStorage.getItem("token") || null,
      user: JSON.parse(localStorage.getItem("user") || "null"),
      page: localStorage.getItem("token") ? "dashboard" : "login",
      theme: localStorage.getItem("theme") || "dark",
      searchQuery: "",
      searchResults: [],
      searchOpen: false,
      activeFileId: null,
      fileDetails: null,
      filesCache: [],
    };

    applyTheme(state.theme);
    render();

    /*************** THEME *************************************/
    function applyTheme(theme) {
      const html = document.documentElement;
      if (theme === "light") {
        html.setAttribute("data-theme", "light");
      } else {
        html.setAttribute("data-theme", "dark");
      }
    }

    /*************** RENDER ROOT *******************************/
    function render() {
      if (!state.token) {
        renderAuth();
      } else {
        renderMainLayout();
      }
    }

    /*************** AUTH UI ***********************************/
    function renderAuth() {
      app.innerHTML = `
        <div class="min-h-screen flex items-center justify-center px-4">
          <div class="glass-strong shadow-glass rounded-3xl p-8 max-w-md w-full text-slate-100 iridescent-border">
            <div class="flex justify-between items-center mb-6">
              <h1 class="text-2xl font-semibold">Contract Cell ‚Äì Secure Access</h1>
              <button id="themeToggle" class="p-2 rounded-full glass text-xs">
                ${state.theme === "dark" ? "Light" : "Dark"}
              </button>
            </div>

            <div class="mb-4">
              <label class="block text-sm mb-1">Cloudflare Worker URL</label>
              <input id="workerUrlInput"
                class="w-full glass px-3 py-2 rounded-xl text-sm outline-none"
                placeholder="https://your-worker-url.example.com"
                value="${WORKER_URL}">
              <p class="text-xs text-slate-300 mt-1">
                Backend ka URL yahan set karein. Saare API calls yahi jayenge.
              </p>
            </div>

            <div class="flex gap-2 mb-6 text-xs">
              <button id="tabLogin" class="flex-1 py-2 rounded-xl glass ${state.page === "login" ? "border border-iridescent1" : ""}">Login</button>
              <button id="tabSignup" class="flex-1 py-2 rounded-xl glass ${state.page === "signup" ? "border border-iridescent1" : ""}">Sign up</button>
            </div>

            ${state.page === "login" ? loginFormHTML() : signupFormHTML()}
          </div>
        </div>
      `;

      document.getElementById("themeToggle").onclick = () => {
        state.theme = state.theme === "dark" ? "light" : "dark";
        localStorage.setItem("theme", state.theme);
        applyTheme(state.theme);
        render();
      };
      document.getElementById("workerUrlInput").onchange = (e) => {
        WORKER_URL = e.target.value.trim();
        localStorage.setItem("workerUrl", WORKER_URL);
      };
      document.getElementById("tabLogin").onclick = () => {
        state.page = "login";
        render();
      };
      document.getElementById("tabSignup").onclick = () => {
        state.page = "signup";
        render();
      };

      if (state.page === "login") bindLoginEvents();
      else bindSignupEvents();
    }

    function loginFormHTML() {
      return `
        <form id="loginForm" class="space-y-4">
          <div>
            <label class="block text-sm mb-1">Email</label>
            <input type="email" name="email" required
              class="w-full glass px-3 py-2 rounded-xl text-sm outline-none">
          </div>
          <div>
            <label class="block text-sm mb-1">Password</label>
            <input type="password" name="password" required
              class="w-full glass px-3 py-2 rounded-xl text-sm outline-none">
          </div>
          <button type="submit" class="w-full mt-4 py-2 rounded-xl glass-strong shadow-glass text-sm font-semibold">
            Login
          </button>
          <p id="authMessage" class="text-xs text-red-300 mt-2"></p>
        </form>
      `;
    }

    function signupFormHTML() {
      return `
        <form id="signupForm" class="space-y-4">
          <div>
            <label class="block text-sm mb-1">Name</label>
            <input type="text" name="name" required
              class="w-full glass px-3 py-2 rounded-xl text-sm outline-none">
          </div>
          <div>
            <label class="block text-sm mb-1">Email</label>
            <input type="email" name="email" required
              class="w-full glass px-3 py-2 rounded-xl text-sm outline-none">
          </div>
          <div>
            <label class="block text-sm mb-1">Password</label>
            <input type="password" name="password" required
              class="w-full glass px-3 py-2 rounded-xl text-sm outline-none">
          </div>
          <button type="submit" class="w-full mt-4 py-2 rounded-xl glass-strong shadow-glass text-sm font-semibold">
            Signup Request
          </button>
          <p id="authMessage" class="text-xs text-slate-200 mt-2">
            Signup ke baad admin approval ke baad hi login hoga.
          </p>
        </form>
      `;
    }

    function bindLoginEvents() {
      const form = document.getElementById("loginForm");
      form.onsubmit = async (e) => {
        e.preventDefault();
        const fd = new FormData(form);
        const payload = {
          email: fd.get("email"),
          password: fd.get("password"),
        };
        try {
          const res = await fetch(WORKER_URL + "/auth/login", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(payload),
          });
          const data = await res.json();
          if (!res.ok) {
            document.getElementById("authMessage").textContent = data.error || "Login failed";
            return;
          }
          state.token = data.token;
          state.user = data.user;
          localStorage.setItem("token", state.token);
          localStorage.setItem("user", JSON.stringify(state.user));
          state.page = "dashboard";
          render();
        } catch (err) {
          document.getElementById("authMessage").textContent = "Network error";
        }
      };
    }

    function bindSignupEvents() {
      const form = document.getElementById("signupForm");
      form.onsubmit = async (e) => {
        e.preventDefault();
        const fd = new FormData(form);
        const payload = {
          name: fd.get("name"),
          email: fd.get("email"),
          password: fd.get("password"),
        };
        try {
          const res = await fetch(WORKER_URL + "/auth/signup", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(payload),
          });
          const data = await res.json();
          const msgEl = document.getElementById("authMessage");
          if (!res.ok) {
            msgEl.textContent = data.error || "Signup failed";
            return;
          }
          msgEl.textContent = data.message || "Signup request sent.";
        } catch (err) {
          document.getElementById("authMessage").textContent = "Network error";
        }
      };
    }

    /*************** MAIN LAYOUT ********************************/
    function renderMainLayout() {
      app.innerHTML = `
        <div class="min-h-screen flex flex-col">
          <header class="glass-strong shadow-glass px-6 py-3 flex items-center justify-between">
            <div class="flex items-center gap-3">
              <div class="w-9 h-9 rounded-2xl glass flex items-center justify-center text-xs font-semibold">
                CMC
              </div>
              <div>
                <div class="text-sm font-semibold">Contract Management Cell</div>
                <div class="text-xs text-slate-300">Digital File Management System</div>
              </div>
            </div>
            <div class="flex-1 mx-8">
              ${searchBoxHTML()}
            </div>
            <div class="flex items-center gap-3">
              <button id="themeToggle" class="glass px-3 py-1 rounded-xl text-xs">
                ${state.theme === "dark" ? "üåô Dark" : "‚òÄÔ∏è Light"}
              </button>
              <div class="text-xs text-right">
                <div>${state.user?.name || "User"}</div>
                <div class="text-slate-300">${state.user?.email || ""}</div>
              </div>
              <button id="logoutBtn" class="glass px-3 py-1 rounded-xl text-xs">
                Logout
              </button>
            </div>
          </header>

          <div class="flex flex-1 overflow-hidden">
            <aside class="w-60 glass-strong shadow-glass m-4 rounded-3xl p-4 flex flex-col gap-2">
              <button data-page="dashboard" class="nav-btn ${state.page === "dashboard" ? "bg-white/10" : ""}">Dashboard</button>
              <button data-page="files" class="nav-btn ${state.page === "files" ? "bg-white/10" : ""}">File Manager</button>
              <button data-page="admin" class="nav-btn ${state.page === "admin" ? "bg-white/10" : ""}">Admin Panel</button>
              <button data-page="settings" class="nav-btn ${state.page === "settings" ? "bg-white/10" : ""}">Settings</button>
            </aside>

            <main class="flex-1 m-4 mr-4 glass-strong shadow-glass rounded-3xl p-4 overflow-auto relative">
              ${state.page === "dashboard"
                ? dashboardHTML()
                : state.page === "files"
                ? fileManagerHTML()
                : state.page === "admin"
                ? adminPanelHTML()
                : settingsHTML()
              }
            </main>
          </div>

          ${state.fileDetails ? filePreviewSliderHTML() : ""}
        </div>
      `;

      document.querySelectorAll(".nav-btn").forEach((btn) => {
        btn.classList.add("w-full", "text-left", "px-3", "py-2", "rounded-2xl", "text-sm");
        btn.onclick = () => {
          state.page = btn.dataset.page;
          render();
        };
      });

      document.getElementById("logoutBtn").onclick = () => {
        localStorage.removeItem("token");
        localStorage.removeItem("user");
        state.token = null;
        state.user = null;
        state.page = "login";
        render();
      };

      document.getElementById("themeToggle").onclick = () => {
        state.theme = state.theme === "dark" ? "light" : "dark";
        localStorage.setItem("theme", state.theme);
        applyTheme(state.theme);
        render();
      };

      bindSearchEvents();
      const workerInput = document.getElementById("settingsWorkerUrl");
      if (workerInput) {
        workerInput.onchange = (e) => {
          WORKER_URL = e.target.value.trim();
          localStorage.setItem("workerUrl", WORKER_URL);
        };
      }

      bindFileManagerEvents();
      bindSettingsEvents();
    }

    /*************** SEARCH UI *********************************/
    function searchBoxHTML() {
      const suggestions =
        state.searchOpen && state.searchResults.length
          ? `<div class="absolute mt-1 w-full glass rounded-2xl shadow-glass max-h-64 overflow-auto z-20">
              ${state.searchResults
                .map(
                  (r, idx) => `
                <div class="px-3 py-2 text-xs hover:bg-white/10 cursor-pointer" data-idx="${idx}">
                  <div class="font-semibold">${r.label}</div>
                  <div class="text-[10px] text-slate-300 uppercase">${r.type}</div>
                </div>`
                )
                .join("")}
            </div>`
          : "";

      return `
        <div class="relative">
          <input id="globalSearch"
            class="w-full glass px-4 py-2 rounded-2xl text-xs outline-none"
            placeholder="Search by File No, File Name, Firm, Contract..."
            value="${state.searchQuery}">
          ${suggestions}
        </div>
      `;
    }

    function bindSearchEvents() {
      const input = document.getElementById("globalSearch");
      if (!input) return;
      let timer = null;

      input.oninput = (e) => {
        state.searchQuery = e.target.value;
        if (timer) clearTimeout(timer);
        if (!state.searchQuery.trim()) {
          state.searchResults = [];
          state.searchOpen = false;
          render();
          return;
        }
        timer = setTimeout(() => doSearch(state.searchQuery), 250);
      };

      input.onfocus = () => {
        if (state.searchResults.length) {
          state.searchOpen = true;
          render();
        }
      };

      document.addEventListener(
        "click",
        (e) => {
          if (!e.target.closest("#globalSearch") && !e.target.closest("[data-idx]")) {
            if (state.searchOpen) {
              state.searchOpen = false;
              render();
            }
          }
        },
        { capture: true }
      );

      document.querySelectorAll("[data-idx]").forEach((el) => {
        el.onclick = () => {
          const idx = Number(el.dataset.idx);
          const item = state.searchResults[idx];
          handleSearchSelect(item);
        };
      });
    }

    async function doSearch(q) {
      try {
        const res = await fetch(WORKER_URL + "/search?q=" + encodeURIComponent(q), {
          headers: { Authorization: "Bearer " + state.token },
        });
        const data = await res.json();
        if (!res.ok) {
          console.error(data);
          return;
        }
        state.searchResults = data.results || [];
        state.searchOpen = true;
        render();
      } catch (err) {
        console.error(err);
      }
    }

    function handleSearchSelect(item) {
      state.searchOpen = false;
      state.searchQuery = "";
      if (item.type === "file") {
        state.page = "files";
        state.activeFileId = item.id;
        loadFileDetails(item.id);
      } else if (item.type === "firm" || item.type === "contract") {
        state.page = "dashboard";
      }
      render();
    }

    /*************** DASHBOARD *********************************/
    function dashboardHTML() {
      return `
        <div class="space-y-4">
          <div class="flex items-center justify-between">
            <h2 class="text-lg font-semibold">Dashboard</h2>
            <span class="text-xs text-slate-300">
              Basic stats ‚Äì aap baad me /stats endpoint se graphs add kar sakte hain.
            </span>
          </div>
          <div class="grid md:grid-cols-3 gap-4">
            <div class="glass rounded-2xl p-4">
              <div class="text-xs text-slate-300 mb-1">Total Files</div>
              <div id="dashTotalFiles" class="text-2xl font-semibold">‚Äì</div>
            </div>
            <div class="glass rounded-2xl p-4">
              <div class="text-xs text-slate-300 mb-1">Active Contracts</div>
              <div id="dashActiveContracts" class="text-2xl font-semibold">‚Äì</div>
            </div>
            <div class="glass rounded-2xl p-4">
              <div class="text-xs text-slate-300 mb-1">Firms</div>
              <div id="dashFirms" class="text-2xl font-semibold">‚Äì</div>
            </div>
          </div>
          <p class="text-xs text-slate-300">
            Abhi ye numbers static hain; aap easily backend me endpoints banake yahan dynamic values la sakte ho.
          </p>
        </div>
      `;
    }

    /*************** FILE MANAGER ******************************/
    function fileManagerHTML() {
      const activeFileInfo = state.fileDetails
        ? `<div class="text-xs text-slate-300 mt-1">${state.fileDetails.file.fileNo} ‚Äì ${state.fileDetails.file.fileName}</div>`
        : `<div class="text-xs text-slate-400 mt-1">Search se file select karein ya nayi file banayein.</div>`;

      return `
        <div class="flex h-full">
          <div class="w-72 border-r border-white/10 pr-3 mr-3 overflow-auto">
            <div class="flex items-center justify-between mb-3">
              <h2 class="text-sm font-semibold">Files & Sub-Files</h2>
              <button id="btnNewFile" class="text-xs glass px-2 py-1 rounded-xl">+ New File</button>
            </div>
            <div id="fileTree" class="space-y-1 text-xs text-slate-300">
              ${renderFileTree()}
            </div>
          </div>

          <div class="flex-1 flex flex-col overflow-hidden">
            <div class="flex items-center justify-between mb-2">
              <div>
                <h2 class="text-sm font-semibold">Details</h2>
                ${activeFileInfo}
              </div>
              <div class="flex gap-2">
                <button id="btnNewSubFile" class="text-xs glass px-2 py-1 rounded-xl">
                  + New Sub-file
                </button>
                <button id="btnShowQR" class="text-xs glass px-2 py-1 rounded-xl">
                  Show QR
                </button>
              </div>
            </div>

            <div class="flex gap-4 h-[calc(100%-2rem)]">
              <div class="flex-1 overflow-auto">
                ${fileDetailsFormHTML()}
              </div>
              <div class="w-72 border-l border-white/10 pl-3">
                <div class="flex items-center justify-between mb-2">
                  <h3 class="text-xs font-semibold">Documents</h3>
                  <button id="btnUploadDoc" class="text-[11px] glass px-2 py-1 rounded-xl">+ Upload</button>
                </div>
                <div id="docList" class="space-y-1 text-xs">
                  ${renderDocList()}
                </div>
              </div>
            </div>
          </div>
        </div>
      `;
    }

    function renderFileTree() {
      const files = state.filesCache || [];
      if (!files.length) {
        return `<div class="text-slate-400 text-[11px]">Abhi file list load nahi hui. Search se open karein ya refresh karein.</div>`;
      }
      const byParent = {};
      for (const f of files) {
        const parentId = f.parentId || "root";
        if (!byParent[parentId]) byParent[parentId] = [];
        byParent[parentId].push(f);
      }
      function renderNode(parentId, level) {
        const list = byParent[parentId] || [];
        return list
          .map((f) => {
            const isActive = String(f.id) === String(state.activeFileId);
            return `
              <div class="pl-${level * 3}">
                <div class="flex items-center gap-1">
                  <button class="text-left w-full px-2 py-1 rounded-xl ${
                    isActive ? "glass-strong" : "glass"
                  } text-[11px]" data-file-id="${f.id}">
                    ${f.fileNo || ""} ‚Äì ${f.fileName || ""}
                  </button>
                </div>
                ${renderNode(f.id, level + 1)}
              </div>
            `;
          })
          .join("");
      }
      return renderNode("root", 0);
    }

    function fileDetailsFormHTML() {
      const f = state.fileDetails?.file || {};
      const cat = (f.category || "").toUpperCase();
      const catClass =
        cat === "PINK_FILE"
          ? "file-tag-pink"
          : cat === "BROWN_FILE"
          ? "file-tag-brown"
          : "file-tag-white";

      return `
        <form id="fileDetailsForm" class="space-y-3 text-xs ${catClass} glass rounded-2xl p-4">
          <div class="grid md:grid-cols-3 gap-3">
            <div>
              <label class="block mb-1">File No.</label>
              <input name="fileNo" value="${f.fileNo || ""}" class="w-full glass px-2 py-1 rounded-xl">
            </div>
            <div>
              <label class="block mb-1">File Name</label>
              <input name="fileName" value="${f.fileName || ""}" class="w-full glass px-2 py-1 rounded-xl">
            </div>
            <div>
              <label class="block mb-1">Category</label>
              <select name="category" class="w-full glass px-2 py-1 rounded-xl">
                <option value="PINK_FILE" ${cat === "PINK_FILE" ? "selected" : ""}>Pink File</option>
                <option value="BROWN_FILE" ${cat === "BROWN_FILE" ? "selected" : ""}>Brown File</option>
                <option value="WHITE_BACKING" ${cat === "WHITE_BACKING" ? "selected" : ""}>White Backing</option>
                <option value="REGISTER" ${cat === "REGISTER" ? "selected" : ""}>Register</option>
                <option value="OTHER" ${cat === "OTHER" ? "selected" : ""}>Other</option>
              </select>
            </div>
          </div>

          <div class="grid md:grid-cols-3 gap-3">
            <div>
              <label class="block mb-1">Supervisor IDs (comma separated)</label>
              <input name="supervisorIds" value="${f.supervisorIds || ""}" class="w-full glass px-2 py-1 rounded-xl">
            </div>
            <div>
              <label class="block mb-1">Location ID</label>
              <input name="locationId" value="${f.locationId || ""}" class="w-full glass px-2 py-1 rounded-xl">
            </div>
            <div>
              <label class="block mb-1">File Type</label>
              <input value="${f.fileType || ""}" disabled class="w-full glass px-2 py-1 rounded-xl opacity-60">
            </div>
          </div>

          <div>
            <label class="block mb-1">Description</label>
            <textarea name="description" rows="3" class="w-full glass px-2 py-1 rounded-xl">${f.description || ""}</textarea>
          </div>

          <div class="flex justify-end gap-2">
            <button type="button" id="btnSaveFile" class="glass px-4 py-1 rounded-xl text-xs">
              Save Changes
            </button>
          </div>
        </form>
      `;
    }

    function renderDocList() {
      const docs = state.fileDetails?.documents || [];
      if (!docs.length) {
        return `<div class="text-slate-400 text-[11px]">No documents attached.</div>`;
      }
      return docs
        .map(
          (d, idx) => `
        <div class="glass rounded-xl px-2 py-1 flex items-center justify-between cursor-pointer text-[11px]" data-doc-idx="${idx}">
          <div class="truncate mr-2">${d.title || "(untitled)"}</div>
          <button class="text-[10px] underline">Preview</button>
        </div>`
        )
        .join("");
    }

    async function loadFilesList() {
      try {
        const res = await fetch(WORKER_URL + "/files", {
          headers: { Authorization: "Bearer " + state.token },
        });
        const data = await res.json();
        if (!res.ok) {
          console.error(data);
          return;
        }
        state.filesCache = data.files || [];
        render();
      } catch (err) {
        console.error(err);
      }
    }

    async function loadFileDetails(id) {
      if (!id) return;
      try {
        const res = await fetch(WORKER_URL + "/files/" + id, {
          headers: { Authorization: "Bearer " + state.token },
        });
        const data = await res.json();
        if (!res.ok) {
          console.error(data);
          return;
        }
        state.fileDetails = data;
        render();
      } catch (err) {
        console.error(err);
      }
    }

    function bindFileManagerEvents() {
      const tree = document.getElementById("fileTree");
      if (tree) {
        tree.querySelectorAll("[data-file-id]").forEach((btn) => {
          btn.onclick = () => {
            const id = btn.dataset.fileId;
            state.activeFileId = id;
            loadFileDetails(id);
          };
        });
      }

      const newFileBtn = document.getElementById("btnNewFile");
      if (newFileBtn) {
        newFileBtn.onclick = async () => {
          const fileNo = prompt("File No:");
          if (!fileNo) return;
          const fileName = prompt("File Name:");
          if (!fileName) return;
          const body = {
            fileNo,
            fileName,
            fileType: "FILE",
            category: "PINK_FILE",
          };
          try {
            const res = await fetch(WORKER_URL + "/files", {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
                Authorization: "Bearer " + state.token,
              },
              body: JSON.stringify(body),
            });
            const data = await res.json();
            if (!res.ok) {
              alert(data.error || "Error creating file");
              return;
            }
            await loadFilesList();
            state.activeFileId = data.id;
            await loadFileDetails(data.id);
          } catch (err) {
            alert("Network error");
          }
        };
      }

      const newSubBtn = document.getElementById("btnNewSubFile");
      if (newSubBtn) {
        newSubBtn.onclick = async () => {
          if (!state.activeFileId) {
            alert("Pehle koi main file select karein.");
            return;
          }
          const fileNo = prompt("Sub-file No:");
          if (!fileNo) return;
          const fileName = prompt("Sub-file Name:");
          if (!fileName) return;
          const body = {
            fileNo,
            fileName,
            category: "WHITE_BACKING",
          };
          try {
            const res = await fetch(
              WORKER_URL + "/files/" + state.activeFileId + "/subfiles",
              {
                method: "POST",
                headers: {
                  "Content-Type": "application/json",
                  Authorization: "Bearer " + state.token,
                },
                body: JSON.stringify(body),
              }
            );
            const data = await res.json();
            if (!res.ok) {
              alert(data.error || "Error creating sub-file");
              return;
            }
            await loadFilesList();
            await loadFileDetails(state.activeFileId);
          } catch (err) {
            alert("Network error");
          }
        };
      }

      const showQR = document.getElementById("btnShowQR");
      if (showQR) {
        showQR.onclick = () => {
          if (!state.fileDetails?.file?.id) {
            alert("File select karein.");
            return;
          }
          const id = state.fileDetails.file.id;
          const url = WORKER_URL + "/qr/" + id;
          window.open(url, "_blank");
        };
      }

      const saveBtn = document.getElementById("btnSaveFile");
      const form = document.getElementById("fileDetailsForm");
      if (saveBtn && form && state.fileDetails?.file?.id) {
        saveBtn.onclick = async () => {
          const fd = new FormData(form);
          const body = {
            fileNo: fd.get("fileNo"),
            fileName: fd.get("fileName"),
            category: fd.get("category"),
            supervisorIds: fd.get("supervisorIds"),
            locationId: fd.get("locationId"),
            description: fd.get("description"),
          };
          try {
            const res = await fetch(WORKER_URL + "/files/" + state.fileDetails.file.id, {
              method: "PUT",
              headers: {
                "Content-Type": "application/json",
                Authorization: "Bearer " + state.token,
              },
              body: JSON.stringify(body),
            });
            const data = await res.json();
            if (!res.ok) {
              alert(data.error || "Error updating file");
              return;
            }
            await loadFilesList();
            await loadFileDetails(state.fileDetails.file.id);
            alert("Saved");
          } catch (err) {
            alert("Network error");
          }
        };
      }

      const uploadBtn = document.getElementById("btnUploadDoc");
      if (uploadBtn) {
        uploadBtn.onclick = async () => {
          if (!state.fileDetails?.file?.id) {
            alert("File select karein.");
            return;
          }
          const input = document.createElement("input");
          input.type = "file";
          input.onchange = async () => {
            const file = input.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = async () => {
              const base64 = reader.result.split(",")[1];
              const body = {
                title: file.name,
                mimeType: file.type || "application/octet-stream",
                base64Data: base64,
              };
              try {
                const res = await fetch(
                  WORKER_URL + "/files/" + state.fileDetails.file.id + "/documents",
                  {
                    method: "POST",
                    headers: {
                      "Content-Type": "application/json",
                      Authorization: "Bearer " + state.token,
                    },
                    body: JSON.stringify(body),
                  }
                );
                const data = await res.json();
                if (!res.ok) {
                  alert(data.error || "Error uploading document");
                  return;
                }
                await loadFileDetails(state.fileDetails.file.id);
              } catch (err) {
                alert("Network error");
              }
            };
            reader.readAsDataURL(file);
          };
          input.click();
        };
      }

      document.querySelectorAll("[data-doc-idx]").forEach((el) => {
        el.onclick = () => {
          const idx = Number(el.dataset.docIdx);
          const doc = state.fileDetails.documents[idx];
          if (!doc) return;
          const driveUrl = "https://drive.google.com/file/d/" + doc.driveFileId + "/view";
          window.open(driveUrl, "_blank");
        };
      });

      if (!state.filesCache.length) {
        loadFilesList();
      }
    }

    /*************** FILE PREVIEW SLIDER ***********************/
    function filePreviewSliderHTML() {
      const f = state.fileDetails.file;
      return `
        <div class="fixed inset-0 flex justify-end bg-black/40">
          <div class="w-96 h-full glass-strong slide-in shadow-glass p-4 flex flex-col">
            <div class="flex items-center justify-between mb-2">
              <div>
                <div class="text-xs text-slate-300">File Preview</div>
                <div class="text-sm font-semibold truncate">${f.fileNo} ‚Äì ${f.fileName}</div>
              </div>
              <button id="closePreview" class="glass px-2 py-1 rounded-xl text-xs">Close</button>
            </div>
            <div class="text-[11px] text-slate-300 mb-2">
              Category: ${f.category} | Type: ${f.fileType} | Location: ${f.locationId}
            </div>
            <div class="flex-1 overflow-auto text-xs">
              <p class="mb-2"><span class="font-semibold">Description:</span> ${f.description || "-"}</p>
              <p class="mb-2"><span class="font-semibold">Supervisors:</span> ${f.supervisorIds || "-"}</p>
              <p class="mb-2"><span class="font-semibold">Created At:</span> ${f.createdAt || "-"}</p>
              <hr class="border-white/10 my-2">
              <p class="text-[11px] text-slate-400">
                QR scan karne par public view me sirf admin-configured fields hi show honge.
              </p>
            </div>
          </div>
        </div>
      `;
    }

    document.addEventListener("click", (e) => {
      if (e.target && e.target.id === "closePreview") {
        state.fileDetails = null;
        render();
      }
    });

    /*************** ADMIN PANEL *******************************/
    function adminPanelHTML() {
      return `
        <div class="space-y-4 text-xs">
          <div class="flex items-center justify-between">
            <h2 class="text-sm font-semibold">Admin Panel</h2>
            <span class="text-[11px] text-slate-300">
              User control, QR config, logs
            </span>
          </div>

          <div class="grid md:grid-cols-3 gap-3">
            <div class="glass rounded-2xl p-3">
              <h3 class="text-xs font-semibold mb-2">User Management</h3>
              <button id="btnLoadUsers" class="glass px-3 py-1 rounded-xl text-[11px]">Load Users</button>
              <div id="adminUsers" class="mt-2 max-h-64 overflow-auto text-[11px]"></div>
            </div>

            <div class="glass rounded-2xl p-3">
              <h3 class="text-xs font-semibold mb-2">QR Code Configuration</h3>
              <button id="btnLoadQRConfig" class="glass px-3 py-1 rounded-xl text-[11px]">Load Config</button>
              <div id="adminQRConfig" class="mt-2 max-h-64 overflow-auto text-[11px]"></div>
              <button id="btnSaveQRConfig" class="mt-2 glass px-3 py-1 rounded-xl text-[11px]">Save</button>
            </div>

            <div class="glass rounded-2xl p-3">
              <h3 class="text-xs font-semibold mb-2">Activity Logs</h3>
              <button id="btnLoadLogs" class="glass px-3 py-1 rounded-xl text-[11px]">Load Logs</button>
              <div id="adminLogs" class="mt-2 max-h-64 overflow-auto text-[11px]"></div>
            </div>
          </div>
        </div>
      `;
    }

    async function bindSettingsEvents() {
      const themeSel = document.getElementById("settingsTheme");
      if (themeSel) {
        themeSel.onchange = (e) => {
          state.theme = e.target.value;
          localStorage.setItem("theme", state.theme);
          applyTheme(state.theme);
          render();
        };
      }

      const workerInput = document.getElementById("settingsWorkerUrl");
      if (workerInput) {
        workerInput.onchange = (e) => {
          WORKER_URL = e.target.value.trim();
          localStorage.setItem("workerUrl", WORKER_URL);
        };
      }

      // Admin panel events
      const btnLoadUsers = document.getElementById("btnLoadUsers");
      if (btnLoadUsers) {
        btnLoadUsers.onclick = async () => {
          try {
            const res = await fetch(WORKER_URL + "/admin/users", {
              headers: { Authorization: "Bearer " + state.token },
            });
            const data = await res.json();
            if (!res.ok) {
              alert(data.error || "Cannot load users");
              return;
            }
            const container = document.getElementById("adminUsers");
            container.innerHTML =
              data.users
                .map(
                  (u) => `
              <div class="glass rounded-xl px-2 py-1 mb-1 flex items-center justify-between">
                <div>
                  <div>${u.name || "(no name)"} ‚Äì ${u.email}</div>
                  <div class="text-[10px] text-slate-300">Role: ${u.role} | Active: ${u.isActive}</div>
                </div>
                <div class="flex flex-col gap-1">
                  <button class="px-2 py-1 rounded-xl text-[10px] glass" data-approve="${u.id}">Approve</button>
                  <button class="px-2 py-1 rounded-xl text-[10px] glass" data-make-admin="${u.id}">Make ADMIN</button>
                </div>
              </div>`
                )
                .join("") || "<div class='text-[11px] text-slate-400'>No users.</div>";

            container.querySelectorAll("[data-approve]").forEach((btn) => {
              btn.onclick = async () => {
                const id = btn.dataset.approve;
                const res2 = await fetch(WORKER_URL + "/admin/users/" + id + "/approve", {
                  method: "POST",
                  headers: { Authorization: "Bearer " + state.token },
                });
                const d2 = await res2.json();
                if (!res2.ok) {
                  alert(d2.error || "Error approving");
                  return;
                }
                btnLoadUsers.click();
              };
            });

            container.querySelectorAll("[data-make-admin]").forEach((btn) => {
              btn.onclick = async () => {
                const id = btn.dataset.makeAdmin;
                const res2 = await fetch(WORKER_URL + "/admin/users/" + id + "/role", {
                  method: "POST",
                  headers: {
                    "Content-Type": "application/json",
                    Authorization: "Bearer " + state.token,
                  },
                  body: JSON.stringify({ role: "ADMIN" }),
                });
                const d2 = await res2.json();
                if (!res2.ok) {
                  alert(d2.error || "Error changing role");
                  return;
                }
                btnLoadUsers.click();
              };
            });
          } catch (err) {
            alert("Network error");
          }
        };
      }

      const btnLoadQRConfig = document.getElementById("btnLoadQRConfig");
      const btnSaveQRConfig = document.getElementById("btnSaveQRConfig");
      if (btnLoadQRConfig) {
        btnLoadQRConfig.onclick = async () => {
          try {
            const res = await fetch(WORKER_URL + "/admin/qr-config", {
              headers: { Authorization: "Bearer " + state.token },
            });
            const data = await res.json();
            if (!res.ok) {
              alert(data.error || "Error loading config");
              return;
            }
            const container = document.getElementById("adminQRConfig");
            container.innerHTML =
              data.items
                .map(
                  (item, idx) => `
              <div class="flex items-center justify-between mb-1">
                <div>
                  <div>${item.label}</div>
                  <div class="text-[10px] text-slate-300">${item.fieldKey}</div>
                </div>
                <label class="inline-flex items-center cursor-pointer">
                  <input type="checkbox" class="sr-only peer" data-qr-idx="${idx}" ${
                    String(item.show).toLowerCase() === "true" ? "checked" : ""
                  }>
                  <div class="w-9 h-5 bg-slate-500 peer-focus:outline-none rounded-full peer peer-checked:bg-emerald-500 transition"></div>
                </label>
              </div>`
                )
                .join("") || "<div class='text-[11px] text-slate-400'>No config.</div>";
            container.dataset.raw = JSON.stringify(data.items);
          } catch (err) {
            alert("Network error");
          }
        };
      }

      if (btnSaveQRConfig) {
        btnSaveQRConfig.onclick = async () => {
          const container = document.getElementById("adminQRConfig");
          if (!container.dataset.raw) {
            alert("Load config first");
            return;
          }
          let items = JSON.parse(container.dataset.raw);
          container.querySelectorAll("[data-qr-idx]").forEach((inp) => {
            const idx = Number(inp.dataset.qrIdx);
            items[idx].show = inp.checked;
          });
          try {
            const res = await fetch(WORKER_URL + "/admin/qr-config", {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
                Authorization: "Bearer " + state.token,
              },
              body: JSON.stringify({ items }),
            });
            const data = await res.json();
            if (!res.ok) {
              alert(data.error || "Error saving config");
              return;
            }
            alert("QR config saved");
          } catch (err) {
            alert("Network error");
          }
        };
      }

      const btnLoadLogs = document.getElementById("btnLoadLogs");
      if (btnLoadLogs) {
        btnLoadLogs.onclick = async () => {
          try {
            const res = await fetch(WORKER_URL + "/admin/logs", {
              headers: { Authorization: "Bearer " + state.token },
            });
            const data = await res.json();
            if (!res.ok) {
              alert(data.error || "Error loading logs");
              return;
            }
            const container = document.getElementById("adminLogs");
            container.innerHTML =
              data.logs
                .slice(-50)
                .reverse()
                .map(
                  (log) => `
              <div class="glass rounded-xl px-2 py-1 mb-1">
                <div>${log.action}</div>
                <div class="text-[10px] text-slate-300">${log.timestamp} | User: ${log.userId}</div>
              </div>`
                )
                .join("") || "<div class='text-[11px] text-slate-400'>No logs.</div>";
          } catch (err) {
            alert("Network error");
          }
        };
      }
    }

    /*************** SETTINGS **********************************/
    function settingsHTML() {
      return `
        <div class="space-y-4 text-xs">
          <h2 class="text-sm font-semibold">Settings</h2>
          <div class="glass rounded-2xl p-3 grid md:grid-cols-2 gap-3">
            <div>
              <label class="block mb-1">Cloudflare Worker URL</label>
              <input id="settingsWorkerUrl" value="${WORKER_URL}" class="w-full glass px-2 py-1 rounded-xl">
              <p class="text-[11px] text-slate-300 mt-1">
                Yahan change karne se future sessions ke liye bhi save ho jayega.
              </p>
            </div>
            <div>
              <label class="block mb-1">Theme</label>
              <select id="settingsTheme" class="w-full glass px-2 py-1 rounded-xl">
                <option value="dark" ${state.theme === "dark" ? "selected" : ""}>Dark Iridescent</option>
                <option value="light" ${state.theme === "light" ? "selected" : ""}>Light Iridescent</option>
              </select>
            </div>
          </div>
        </div>
      `;
    }
  </script>
</body>
</html>
