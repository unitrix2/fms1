<!DOCTYPE html>
<html lang="hi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Railway Professional Exam Portal</title>
    
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>

    <style>
        :root { 
            --primary: #b71c1c; --primary-dark: #7f0000; --primary-light: #ffcdd2;
            --secondary: #eceff1; --text: #263238; --white: #ffffff;
            --correct: #2e7d32; --wrong: #c62828; --review: #7b1fa2; --warning: #ff8f00;
        }
        
        body { font-family: 'Segoe UI', Roboto, sans-serif; margin: 0; background: var(--secondary); color: var(--text); display: flex; flex-direction: column; height: 100vh; overflow: hidden; }

        /* --- LOGIN PAGE (Original Animation Kept) --- */
        #login-page { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: radial-gradient(circle at center, #0d47a1 0%, #000000 100%); display: flex; justify-content: center; align-items: center; z-index: 10000; }
        .login-card { background: rgba(255, 255, 255, 0.1); backdrop-filter: blur(20px); padding: 30px; border-radius: 20px; width: 350px; text-align: center; border: 1px solid rgba(255,255,255,0.2); color: white; }
        .input-group input { width: 100%; padding: 12px; margin: 10px 0; border-radius: 8px; border: none; box-sizing: border-box; }
        .login-btn { width: 100%; padding: 12px; background: var(--primary); color: white; border: none; border-radius: 50px; cursor: pointer; font-weight: bold; text-transform: uppercase; }
        .google-btn { width: 100%; padding: 12px; background: white; color: #333; border: none; border-radius: 50px; cursor: pointer; margin-top: 10px; display: flex; align-items: center; justify-content: center; gap: 10px; font-weight: bold; }

        /* --- APP HEADER --- */
        #app-content { display: none; height: 100%; flex-direction: column; }
        header { background: white; padding: 10px 20px; display: flex; justify-content: space-between; align-items: center; border-bottom: 3px solid var(--primary); box-shadow: 0 2px 10px rgba(0,0,0,0.1); z-index: 100; }
        .user-profile { display: flex; align-items: center; gap: 12px; background: #f5f5f5; padding: 5px 15px; border-radius: 50px; border: 1px solid #ddd; }
        .user-photo { width: 35px; height: 35px; border-radius: 50%; border: 2px solid var(--primary); }
        .header-title h2 { margin: 0; color: var(--primary); font-size: 1.2rem; }
        
        /* --- THEME PALETTE --- */
        .theme-switcher { display: flex; gap: 5px; }
        .dot { width: 15px; height: 15px; border-radius: 50%; cursor: pointer; border: 1px solid #ccc; }

        /* --- DASHBOARD --- */
        #dashboard { flex: 1; padding: 20px; overflow-y: auto; }
        .filter-bar { margin-bottom: 20px; display: flex; gap: 10px; align-items: center; }
        .dropdown { padding: 10px; border-radius: 5px; border: 1px solid #ccc; background: white; font-weight: bold; }
        .test-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 15px; }
        .test-card { background: white; padding: 20px; border-radius: 10px; border-left: 6px solid var(--primary); box-shadow: 0 2px 5px rgba(0,0,0,0.05); display: flex; justify-content: space-between; align-items: center; cursor: pointer; transition: 0.3s; }
        .test-card:hover { transform: translateY(-3px); box-shadow: 0 5px 15px rgba(0,0,0,0.1); }
        .card-actions { display: flex; gap: 10px; }
        .btn-icon { background: #eee; border: none; padding: 8px; border-radius: 5px; cursor: pointer; font-size: 1.2rem; }
        .btn-icon:hover { background: #ddd; }

        /* --- QUIZ INTERFACE (RESEARCHED LAYOUT) --- */
        #quiz-view { display: none; height: 100%; flex: 1; gap: 15px; padding: 15px; box-sizing: border-box; background: #f0f2f5; }
        .q-main { flex: 3; background: white; border-radius: 12px; display: flex; flex-direction: column; overflow: hidden; box-shadow: 0 4px 15px rgba(0,0,0,0.05); }
        .q-header { padding: 15px 25px; background: #f8f9fa; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; align-items: center; }
        .timer { font-family: monospace; font-size: 1.4rem; font-weight: bold; color: var(--primary); }
        
        .q-content { flex: 1; padding: 30px; overflow-y: auto; }
        .q-text { font-size: 1.25rem; font-weight: 600; margin-bottom: 15px; line-height: 1.4; }
        .q-hindi { color: #546e7a; font-size: 1.15rem; margin-bottom: 25px; }
        .option-label { display: flex; align-items: flex-start; padding: 15px; border: 2px solid #eee; border-radius: 10px; margin-bottom: 12px; cursor: pointer; transition: 0.2s; }
        .option-label:hover { background: #f9f9f9; border-color: var(--primary); }
        .option-label input { margin-right: 15px; transform: scale(1.4); accent-color: var(--primary); }

        .q-footer { padding: 15px 25px; background: white; border-top: 1px solid #eee; display: flex; justify-content: space-between; }
        
        /* --- SIDEBAR (PALETTE) --- */
        .q-sidebar { flex: 1; max-width: 320px; background: white; border-radius: 12px; padding: 20px; display: flex; flex-direction: column; box-shadow: 0 4px 15px rgba(0,0,0,0.05); }
        .palette-grid { display: grid; grid-template-columns: repeat(5, 1fr); gap: 8px; overflow-y: auto; margin-top: 15px; }
        .p-btn { padding: 10px 0; text-align: center; border: 1px solid #ddd; border-radius: 6px; cursor: pointer; font-weight: bold; font-size: 0.9rem; }
        .p-btn.done { background: var(--primary); color: white; border-color: var(--primary); }
        .p-btn.review { background: var(--review); color: white; border-color: var(--review); }
        .p-btn.current { border: 2px solid var(--warning); transform: scale(1.1); }

        .btn { padding: 10px 25px; border: none; border-radius: 6px; cursor: pointer; font-weight: bold; color: white; text-transform: uppercase; }
        .btn-back { background: #546e7a; margin-right: 10px; }
        .btn-prev { background: #90a4ae; }
        .btn-next { background: var(--primary); }
        .btn-review { background: var(--review); }
        .btn-submit { background: var(--correct); }

        /* --- PRINT BOOKLET --- */
        @media print {
            body * { visibility: hidden; }
            #print-area, #print-area * { visibility: visible; }
            #print-area { position: absolute; left:0; top:0; width:100%; padding: 20px; }
            .print-q { margin-bottom: 30px; border-bottom: 1px dashed #ccc; padding-bottom: 15px; break-inside: avoid; }
            .print-opts { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 10px; }
            .print-key { break-before: page; text-align: center; }
        }
    </style>
</head>
<body>

<div id="login-page">
    <div class="login-card">
        <img src="https://images.seeklogo.com/logo-png/31/1/indian-railways-logo-png_seeklogo-310214.png" width="70">
        <h2>LDCE Mock Test</h2>
        <div class="input-group"><input type="text" id="username" placeholder="Username / PF Number"></div>
        <div class="input-group"><input type="password" id="password" placeholder="Password"></div>
        <button class="login-btn" onclick="manualLogin()">Login</button>
        <div style="margin: 15px 0; font-size: 0.8rem;">OR</div>
        <button class="google-btn" onclick="googleLogin()">
            <img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg" width="18"> Google Login
        </button>
        <p id="login-msg" style="color: yellow; margin-top: 10px; font-size: 0.85rem;"></p>
    </div>
</div>

<div id="app-content">
    <header>
        <div style="display:flex; align-items:center; gap:15px;">
            <img src="https://images.seeklogo.com/logo-png/31/1/indian-railways-logo-png_seeklogo-310214.png" width="40">
            <div class="header-title"><h2 id="dynamic-title">Exam Portal</h2></div>
        </div>
        
        <div class="header-controls">
            <div class="theme-switcher">
                <div class="dot" style="background:#b71c1c" onclick="changeTheme('#b71c1c')"></div>
                <div class="dot" style="background:#1565c0" onclick="changeTheme('#1565c0')"></div>
                <div class="dot" style="background:#2e7d32" onclick="changeTheme('#2e7d32')"></div>
                <div class="dot" style="background:#37474f" onclick="changeTheme('#37474f')"></div>
            </div>
            <div class="user-profile">
                <img id="u-photo" src="" class="user-photo">
                <span id="u-name" style="font-weight:bold; margin:0 10px;">User</span>
                <button class="btn-icon" onclick="logout()" title="Logout">Logout</button>
            </div>
        </div>
    </header>

    <main id="dashboard">
        <div id="filter-area" class="filter-bar">
            <span>Select Role:</span>
            <select id="cat-select" class="dropdown" onchange="loadTestCards(this.value)">
                </select>
        </div>
        <div id="test-list" class="test-grid"></div>
    </main>

    <div id="quiz-view">
        <div class="q-main">
            <div class="q-header">
                <button class="btn btn-back" onclick="confirmExit()">‚Üê Exit</button>
                <span id="active-test-name" style="font-weight:bold;">Test Name</span>
                <div class="timer" id="timer">00:00:00</div>
            </div>
            <div class="q-content" id="q-body">
                </div>
            <div class="q-footer">
                <button class="btn btn-prev" onclick="nav(-1)">Previous</button>
                <button class="btn btn-review" onclick="markForReview()">Review Later</button>
                <button class="btn btn-next" onclick="nav(1)">Next Question</button>
                <button class="btn btn-submit" onclick="finishTest()">Finish Test</button>
            </div>
        </div>
        
        <div class="q-sidebar">
            <h4 style="margin:0;">Question Palette</h4>
            <div class="palette-grid" id="palette"></div>
            <hr style="width:100%; margin: 20px 0;">
            <button class="btn-icon" style="width:100%; background:#fff3e0; color:#e65100; font-weight:bold;" onclick="reportQ()">‚ö†Ô∏è Report Error</button>
        </div>
    </div>
</div>

<div id="print-area"></div>

<script>
    // --- DATABASE CONFIG ---
    const GH_USER = 'unitrix2', GH_REPO = 'fms1';
    
    const firebaseConfig = {
        apiKey: "AIzaSyCxCLczt1L01qr3DmdvAv_EU3IsWhgxs0w",
        authDomain: "fms1-39dca.firebaseapp.com",
        projectId: "fms1-39dca",
        storageBucket: "fms1-39dca.firebasestorage.app",
        messagingSenderId: "46968102286",
        appId: "1:46968102286:web:452d87de53dfcc2028d8df"
    };
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth(), db = firebase.firestore(), provider = new firebase.auth.GoogleAuthProvider();

    let userObj = null, questions = [], answers = {}, review = {}, qIdx = 0, timerInt = null, totalSeconds = 0;

    // --- AUTHENTICATION ---
    function googleLogin() {
        auth.signInWithPopup(provider).then(res => validateAccess(res.user.email, 'google')).catch(e => alert(e.message));
    }

    async function manualLogin() {
        const u = document.getElementById('username').value, p = document.getElementById('password').value;
        const res = await fetch('users.json');
        const users = await res.json();
        const valid = users.find(x => x.username === u && x.password === p);
        if(valid) validateAccess(valid, 'manual');
        else document.getElementById('login-msg').innerText = "Invalid Credentials";
    }

    async function validateAccess(cred, type) {
        let email = type === 'google' ? cred : cred.username;
        let roles = [], name = "User", photo = "https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/person.svg";

        if(type === 'google') {
            const res = await fetch('allowed_users.json');
            const allowed = await res.json();
            const found = allowed.find(x => x.email.toLowerCase() === email.toLowerCase());
            if(found) { roles = found.access; name = email.split('@')[0]; }
        } else {
            roles = cred.access; name = cred.name;
        }

        if(roles.length > 0) {
            userObj = { name, email, roles, photo };
            sessionStorage.setItem('ldce_user', JSON.stringify(userObj));
            initPortal();
        } else {
            alert("No access found for this ID.");
            auth.signOut();
        }
    }

    // --- APP INITIALIZATION ---
    function initPortal() {
        document.getElementById('login-page').style.display = 'none';
        document.getElementById('app-content').style.display = 'flex';
        document.getElementById('u-name').innerText = userObj.name;
        document.getElementById('u-photo').src = userObj.photo;

        const title = userObj.roles.includes('admin') ? "Admin Portal" : "LDCE " + userObj.roles.map(r=>r.toUpperCase()).join(' / ') + " Exam";
        document.getElementById('dynamic-title').innerText = title;

        const sel = document.getElementById('cat-select');
        sel.innerHTML = '<option value="">-- Choose Category --</option>';
        
        let rolesToShow = userObj.roles.includes('admin') ? ['tech-iii', 'je', 'adme'] : userObj.roles;
        rolesToShow.forEach(r => sel.innerHTML += `<option value="${r}">${r.toUpperCase()}</option>`);

        if(rolesToShow.length === 1) {
            document.getElementById('filter-area').style.display = 'none';
            loadTestCards(rolesToShow[0]);
        } else {
            document.getElementById('filter-area').style.display = 'flex';
        }
    }

    // --- DASHBOARD TOOLS ---
    async function loadTestCards(cat) {
        if(!cat) return;
        const grid = document.getElementById('test-list');
        grid.innerHTML = "Searching folders...";
        try {
            const res = await fetch(`https://api.github.com/repos/${GH_USER}/${GH_REPO}/contents/tests/${cat}`);
            const files = await res.json();
            grid.innerHTML = "";
            files.filter(f => f.name.endsWith('.json')).forEach(f => {
                const name = f.name.replace('.json','').replace(/_/g,' ').toUpperCase();
                const card = document.createElement('div');
                card.className = "test-card";
                card.innerHTML = `
                    <div style="flex:1" onclick="startExam('${f.download_url}', '${name}')">
                        <div style="font-weight:bold;">${name}</div>
                        <div style="font-size:0.8rem; color:#666;">Click to take test ‚ûî</div>
                    </div>
                    ${userObj.roles.includes('admin') ? `<button class="btn-icon" onclick="printTest('${f.download_url}', '${name}')" title="Print Booklet">üñ®Ô∏è</button>` : ''}
                `;
                grid.appendChild(card);
            });
        } catch(e) { grid.innerHTML = "No papers found in this directory."; }
    }

    // --- QUIZ ENGINE ---
    async function startExam(url, name) {
        const res = await fetch(url);
        questions = await res.json();
        answers = {}; review = {}; qIdx = 0; totalSeconds = 0;
        
        document.getElementById('dashboard').style.display = 'none';
        document.getElementById('quiz-view').style.display = 'flex';
        document.getElementById('active-test-name').innerText = name;
        
        renderQ();
        renderPalette();
        startTimer();
    }

    function renderQ() {
        const q = questions[qIdx];
        let html = `<div class="q-text">Q${qIdx+1}. ${q.q}</div>`;
        if(q.h) html += `<div class="q-hindi">${q.h}</div>`;
        html += `<div class="options">`;
        q.o.forEach((opt, i) => {
            const checked = answers[qIdx] === i ? 'checked' : '';
            html += `<label class="option-label"><input type="radio" name="opt" onclick="save(${i})" ${checked}> ${opt}</label>`;
        });
        document.getElementById('q-body').innerHTML = html + "</div>";
        updateUI();
    }

    function save(idx) { answers[qIdx] = idx; updateUI(); }
    
    function markForReview() { review[qIdx] = !review[qIdx]; updateUI(); }

    function nav(dir) {
        if(qIdx + dir >= 0 && qIdx + dir < questions.length) {
            qIdx += dir;
            renderQ();
        }
    }

    function renderPalette() {
        const p = document.getElementById('palette');
        p.innerHTML = '';
        questions.forEach((_, i) => {
            const b = document.createElement('div');
            b.className = 'p-btn';
            b.innerText = i + 1;
            b.id = `pal-${i}`;
            b.onclick = () => { qIdx = i; renderQ(); };
            p.appendChild(b);
        });
    }

    function updateUI() {
        questions.forEach((_, i) => {
            const b = document.getElementById(`pal-${i}`);
            b.className = 'p-btn';
            if(answers[i] !== undefined) b.classList.add('done');
            if(review[i]) b.classList.add('review');
            if(i === qIdx) b.classList.add('current');
        });
    }

    function startTimer() {
        clearInterval(timerInt);
        timerInt = setInterval(() => {
            totalSeconds++;
            const h = Math.floor(totalSeconds / 3600).toString().padStart(2,'0');
            const m = Math.floor((totalSeconds % 3600) / 60).toString().padStart(2,'0');
            const s = (totalSeconds % 60).toString().padStart(2,'0');
            document.getElementById('timer').innerText = `${h}:${m}:${s}`;
        }, 1000);
    }

    function confirmExit() { if(confirm("Discard test and go back?")) location.reload(); }

    function finishTest() {
        if(!confirm("Are you sure you want to submit?")) return;
        clearInterval(timerInt);
        let score = 0;
        questions.forEach((q, i) => { if(answers[i] === q.c) score++; });
        alert(`Test Submitted!\nScore: ${score} / ${questions.length}\nTime: ${document.getElementById('timer').innerText}`);
        location.reload();
    }

    // --- ADMIN TOOLS ---
    async function printTest(url, name) {
        const res = await fetch(url);
        const data = await res.json();
        let html = `<div class="print-head"><h1>${name}</h1><p>LDCE Departmental Question Booklet</p></div>`;
        let key = `<div class="print-key"><h2>Answer Key</h2><div style="display:grid; grid-template-columns: repeat(5,1fr); gap:10px;">`;
        
        data.forEach((q, i) => {
            html += `<div class="print-q"><b>Q${i+1}. ${q.q}</b><br><span style="font-family:'Nirmala UI'">${q.h||''}</span>`;
            html += `<div class="print-opts">${q.o.map((o, idx) => `<div>(${String.fromCharCode(65+idx)}) ${o}</div>`).join('')}</div></div>`;
            key += `<div>${i+1}. [ ${String.fromCharCode(65+q.c)} ]</div>`;
        });

        document.getElementById('print-area').innerHTML = html + key + "</div>";
        window.print();
        document.getElementById('print-area').innerHTML = "";
    }

    function reportQ() {
        const msg = prompt("What is wrong with Question " + (qIdx+1) + "?");
        if(msg) {
            db.collection('reports').add({
                test: document.getElementById('active-test-name').innerText,
                qIdx: qIdx + 1,
                error: msg,
                user: userObj.email,
                time: new Date()
            }).then(() => alert("Reported to Admin."));
        }
    }

    function changeTheme(color) { document.documentElement.style.setProperty('--primary', color); }
    function logout() { sessionStorage.clear(); auth.signOut(); location.reload(); }

    // Check existing session
    const saved = sessionStorage.getItem('ldce_user');
    if(saved) { userObj = JSON.parse(saved); initPortal(); }
</script>

</body>
</html>
