<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Aurora FMS | Ultimate</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrious/4.0.2/qrious.min.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
  
  <style>
    /* DARK AURORA THEME */
    body { font-family: 'Inter', sans-serif; background-color: #030014; color: #ffffff; overflow-x: hidden; }
    .aurora-bg { position: fixed; inset: 0; z-index: -1; background: radial-gradient(circle at 10% 20%, rgba(88, 28, 135, 0.4) 0%, transparent 40%), radial-gradient(circle at 90% 80%, rgba(236, 72, 153, 0.3) 0%, transparent 40%); filter: blur(60px); animation: pulse 10s infinite alternate; }
    @keyframes pulse { 0% { opacity: 0.8; } 100% { opacity: 0.5; } }

    /* Glass Components */
    .glass-card { background: rgba(255, 255, 255, 0.03); backdrop-filter: blur(20px); border: 1px solid rgba(255, 255, 255, 0.08); box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.5); border-radius: 16px; }
    .glass-input { background: rgba(0, 0, 0, 0.4); border: 1px solid rgba(255, 255, 255, 0.1); color: white; transition: 0.3s; }
    .glass-input:focus { border-color: #d946ef; outline: none; box-shadow: 0 0 10px rgba(217, 70, 239, 0.2); }
    .btn-gradient { background: linear-gradient(135deg, #9333ea, #db2777); }
    .btn-gradient:hover { transform: translateY(-2px); box-shadow: 0 0 15px rgba(219, 39, 119, 0.4); }

    /* File Type Colors */
    .type-Pink { border-left: 4px solid #ec4899; }
    .type-Brown { border-left: 4px solid #d97706; }
    .type-Register { border-left: 4px solid #3b82f6; }
    .type-Sub-File { border-left: 4px solid #8b5cf6; margin-left: 20px; border-radius: 0 16px 16px 0; background: rgba(255,255,255,0.01); }

    .slide-up { animation: slideUp 0.4s ease-out forwards; }
    @keyframes slideUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
    
    /* Search Dropdown */
    .search-dropdown { position: absolute; top: 100%; left: 0; width: 100%; background: #1e1e24; border: 1px solid #333; border-radius: 12px; z-index: 100; max-height: 300px; overflow-y: auto; margin-top: 5px; box-shadow: 0 10px 40px rgba(0,0,0,0.8); }
    .search-item { padding: 10px 15px; border-bottom: 1px solid #333; cursor: pointer; display: flex; justify-content: space-between; align-items: center; }
    .search-item:hover { background: rgba(219, 39, 119, 0.2); }
  </style>
</head>
<body>
  <div class="aurora-bg"></div>
  
  <div id="app" class="min-h-screen flex flex-col relative z-10 text-sm md:text-base">
    
    <transition name="fade"><div v-if="notify" :class="`fixed top-6 right-6 px-6 py-4 rounded-xl shadow-2xl glass-card z-50 flex items-center gap-3 border-l-4 ${notify.type==='error'?'border-red-500':'border-green-400'}`"><i class="fa-solid fa-bell"></i> <span>{{ notify.msg }}</span></div></transition>
    <div v-if="loading" class="fixed inset-0 bg-black/90 flex flex-col justify-center items-center z-[60]"><div class="animate-spin h-16 w-16 border-t-4 border-b-4 border-fuchsia-500 rounded-full"></div><p class="mt-4 font-bold text-fuchsia-400 tracking-widest animate-pulse">PROCESSING</p></div>

    <div v-if="page === 'login'" class="flex-grow flex items-center justify-center p-4">
      <div class="glass-card p-10 rounded-3xl w-full max-w-md slide-up">
        <h1 class="text-4xl font-extrabold text-transparent bg-clip-text bg-gradient-to-r from-purple-400 to-pink-400 text-center mb-2">AURORA FMS</h1>
        <p class="text-gray-400 text-center text-xs tracking-widest uppercase mb-8">Ultimate Access</p>
        <form @submit.prevent="auth">
           <input v-model="authForm.email" placeholder="Username or Email" class="glass-input w-full p-3 rounded-xl mb-4" required>
           <input v-model="authForm.password" type="password" placeholder="Password" class="glass-input w-full p-3 rounded-xl mb-6" required>
           <button class="w-full py-3 btn-gradient rounded-xl font-bold text-white shadow-lg">ENTER SYSTEM</button>
        </form>
      </div>
    </div>

    <div v-else class="flex h-screen overflow-hidden">
      <aside class="w-64 glass-card m-4 mr-0 flex flex-col hidden md:flex">
         <div class="p-6 border-b border-gray-700/50">
            <h2 class="text-2xl font-bold text-white">AURORA</h2>
            <div class="text-xs text-gray-400 mt-1">@{{ user.username }} ({{ user.role }})</div>
         </div>
         <nav class="p-4 space-y-2 flex-1">
            <button @click="navigate('home')" :class="`w-full text-left p-3 rounded-xl flex items-center gap-3 transition ${view==='home'?'bg-purple-600/30 text-white':'text-gray-400 hover:bg-white/5'}`"><i class="fa-solid fa-layer-group w-5 text-center"></i> Categories</button>
            <button v-if="user.role==='Admin'" @click="view='admin'" :class="`w-full text-left p-3 rounded-xl flex items-center gap-3 transition ${view==='admin'?'bg-purple-600/30 text-white':'text-gray-400 hover:bg-white/5'}`"><i class="fa-solid fa-shield-cat w-5 text-center"></i> Admin Panel</button>
         </nav>
         <div class="p-4"><button @click="logout" class="w-full p-3 border border-red-500/30 text-red-400 rounded-xl hover:bg-red-500/20"><i class="fa-solid fa-power-off"></i> Logout</button></div>
      </aside>

      <main class="flex-1 overflow-y-auto p-6">
         
         <div class="glass-card p-3 rounded-2xl flex items-center gap-4 mb-8 sticky top-0 z-40 shadow-xl relative">
            <i class="fa-solid fa-search ml-4 text-gray-400"></i>
            <input v-model="search" type="text" placeholder="Type to search (Contract Name, Firm, File No...)" class="bg-transparent w-full p-2 text-white outline-none" @input="showSuggestions=true" @focus="showSuggestions=true">
            
            <div v-if="search && showSuggestions" class="search-dropdown slide-up" @mouseleave="showSuggestions=false">
               <div v-if="searchResults.length === 0" class="p-4 text-gray-500 text-center">No matches found.</div>
               <div v-for="res in searchResults" :key="res.id" @click="handleSearchSelect(res)" class="search-item">
                  <div>
                     <div class="text-white font-bold">{{ res.title }}</div>
                     <div class="text-xs text-gray-400">{{ res.subtitle }}</div>
                  </div>
                  <span class="text-xs bg-purple-900 px-2 py-1 rounded">{{ res.type }}</span>
               </div>
            </div>
         </div>

         <div v-if="view==='home' && !selectedCat" class="slide-up">
            <div class="flex justify-between items-center mb-6">
               <h2 class="text-2xl font-bold">Categories</h2>
               <button @click="openModal('cat', 'create')" class="btn-gradient px-4 py-2 rounded-xl text-sm font-bold">+ New Category</button>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
               <div v-for="c in db.categories" class="glass-card p-6 relative group hover:bg-white/5 transition">
                  <div @click="selectCat(c)" class="cursor-pointer">
                     <div class="w-12 h-12 rounded-full bg-purple-500/20 flex items-center justify-center text-purple-400 text-xl mb-4"><i :class="c.Icon || 'fa-solid fa-folder'"></i></div>
                     <h3 class="font-bold text-lg">{{ c.Name }}</h3>
                     <div class="text-xs text-gray-500 mt-2">{{ getContractCount(c.CatID) }} Contracts</div>
                  </div>
                  <div class="absolute top-4 right-4 opacity-0 group-hover:opacity-100 transition">
                     <button @click.stop="openModal('cat', 'edit', c)" class="text-blue-400 mr-2"><i class="fa-solid fa-pen"></i></button>
                     <button @click.stop="deleteItem('manageCategory', c.rowIndex)" class="text-red-400"><i class="fa-solid fa-trash"></i></button>
                  </div>
               </div>
            </div>
         </div>

         <div v-if="selectedCat && !selectedCon" class="slide-up">
            <div class="flex items-center gap-2 mb-6 text-gray-400 text-sm cursor-pointer">
               <span @click="selectedCat=null">Categories</span> <i class="fa-solid fa-chevron-right text-xs"></i> <span class="text-white font-bold">{{ selectedCat.Name }}</span>
            </div>
            <div class="flex justify-between items-center mb-6">
               <h2 class="text-2xl font-bold">Contracts</h2>
               <button @click="openModal('con', 'create')" class="btn-gradient px-4 py-2 rounded-xl text-sm font-bold">+ Add Contract</button>
            </div>
            <div class="space-y-4">
               <div v-for="c in filteredContracts" class="glass-card p-5 relative group hover:bg-white/5 flex justify-between items-center">
                  <div @click="selectCon(c)" class="cursor-pointer flex-1">
                     <h3 class="text-xl font-bold text-white">{{ c.FirmName }}</h3>
                     <div class="text-sm text-gray-400 mt-1">Agmt: <span class="text-gray-300">{{ c.AgreementNo }}</span> • {{ c.StartDate }} to {{ c.EndDate }}</div>
                  </div>
                  <div class="text-right flex items-center gap-4">
                     <span :class="`px-2 py-1 rounded text-xs font-bold ${c.Status==='Active'?'bg-green-500/20 text-green-400':'bg-red-500/20 text-red-400'}`">{{ c.Status }}</span>
                     <div class="opacity-0 group-hover:opacity-100 transition">
                        <button @click="openModal('con', 'edit', c)" class="text-blue-400 mr-2"><i class="fa-solid fa-pen"></i></button>
                        <button @click="deleteItem('manageContract', c.rowIndex)" class="text-red-400"><i class="fa-solid fa-trash"></i></button>
                     </div>
                  </div>
               </div>
            </div>
         </div>

         <div v-if="selectedCon" class="slide-up">
            <div class="flex items-center gap-2 mb-6 text-gray-400 text-sm cursor-pointer">
               <span @click="selectedCat=null;selectedCon=null">Categories</span> <i class="fa-solid fa-chevron-right text-xs"></i> 
               <span @click="selectedCon=null">{{ selectedCat.Name }}</span> <i class="fa-solid fa-chevron-right text-xs"></i>
               <span class="text-white font-bold">{{ selectedCon.FirmName }}</span>
            </div>

            <div class="glass-card p-6 rounded-2xl mb-8 border border-purple-500/30">
               <div class="flex justify-between items-start">
                  <div><h1 class="text-3xl font-bold text-white">{{ selectedCon.FirmName }}</h1><p class="text-gray-400 mt-2">{{ selectedCon.Description }}</p></div>
                  <button @click="openModal('file', 'create')" class="btn-gradient px-6 py-3 rounded-xl font-bold shadow-lg"><i class="fa-solid fa-file-circle-plus mr-2"></i> Create Main File</button>
               </div>
            </div>

            <div class="grid gap-4">
               <div v-for="f in parentFiles" :key="f.FileID" :class="`glass-card p-5 relative group ${'type-'+f.Type.split(' ')[0]}`">
                  <div class="flex justify-between items-start">
                     <button @click="f.expand = !f.expand" class="mr-3 mt-1 text-gray-400 hover:text-white transition"><i :class="`fa-solid fa-chevron-${f.expand?'down':'right'}`"></i></button>
                     <div class="flex-1 cursor-pointer" @click="f.expand = !f.expand">
                        <div class="flex items-center gap-3 mb-2">
                           <span class="bg-black/50 px-2 py-1 rounded text-xs font-mono text-gray-300">{{ f.FileNo }}</span>
                           <span :class="`text-xs ${f.Status==='Active'?'text-green-400':'text-red-400'}`">● {{ f.Status }}</span>
                        </div>
                        <h3 class="font-bold text-lg text-white">{{ f.Name }}</h3>
                        <p class="text-sm text-gray-400 mt-1">{{ f.Description }}</p>
                     </div>
                     <div class="flex gap-2">
                        <button @click="downloadQR(f)" class="w-8 h-8 rounded-full bg-white/10 hover:bg-white/20 text-white flex items-center justify-center"><i class="fa-solid fa-qrcode"></i></button>
                        <a v-if="f.AttachmentURL" :href="f.AttachmentURL" target="_blank" class="w-8 h-8 rounded-full bg-blue-600/30 text-blue-400 flex items-center justify-center hover:bg-blue-600 hover:text-white"><i class="fa-solid fa-paperclip"></i></a>
                        <div class="flex flex-col gap-2 ml-2 opacity-0 group-hover:opacity-100 transition">
                           <button @click="openModal('file', 'edit', f)" class="text-blue-400"><i class="fa-solid fa-pen"></i></button>
                           <button @click="deleteItem('manageFile', f.rowIndex)" class="text-red-400"><i class="fa-solid fa-trash"></i></button>
                        </div>
                     </div>
                  </div>
                  <div v-if="f.expand" class="mt-4 pt-4 border-t border-gray-700/50 pl-8">
                     <div class="flex justify-between items-center mb-3">
                        <h4 class="text-xs font-bold text-gray-500 uppercase">Sub-Files</h4>
                        <button @click="openSubFileModal(f)" class="text-xs text-purple-400 hover:text-white transition">+ Add Sub-File</button>
                     </div>
                     <div v-for="sub in getSubFiles(f.FileID)" class="glass-card p-3 mb-2 flex justify-between items-center bg-white/5">
                        <div><div class="text-sm font-bold text-white">{{ sub.Name }}</div><div class="text-xs text-gray-500">{{ sub.FileNo }}</div></div>
                        <div class="flex gap-2"><a v-if="sub.AttachmentURL" :href="sub.AttachmentURL" target="_blank" class="text-blue-400 text-xs">View</a><button @click="deleteItem('manageFile', sub.rowIndex)" class="text-red-400 text-xs"><i class="fa-solid fa-trash"></i></button></div>
                     </div>
                  </div>
               </div>
            </div>
         </div>

         <div v-if="view==='admin'" class="slide-up">
            <h2 class="text-2xl font-bold mb-6">Admin Control Center</h2>
            <div class="grid md:grid-cols-2 gap-6 mb-8">
               
               <div class="glass-card p-6">
                  <div class="flex justify-between mb-4"><h3 class="font-bold">Users</h3><button @click="openModal('user', 'create')" class="text-xs border border-pink-400 px-2 rounded text-pink-400">Add New</button></div>
                  <table class="w-full text-xs text-left">
                     <tr class="text-gray-500 border-b border-gray-700"><th class="pb-2">Username</th><th>Name</th><th>Role</th><th>Action</th></tr>
                     <tr v-for="u in db.adminUsers" class="border-b border-gray-800 hover:bg-white/5">
                        <td class="py-2">{{ u.Username }}</td><td>{{ u.Name }}</td><td>{{ u.Role }}</td>
                        <td>
                           <button v-if="u.Username!=='admin'" @click="openModal('user', 'edit', u)" class="text-blue-400 mr-2"><i class="fa-solid fa-pen"></i></button>
                           <button v-if="u.Username!=='admin'" @click="deleteItem('manageUser', u.rowIndex)" class="text-red-400"><i class="fa-solid fa-trash"></i></button>
                        </td>
                     </tr>
                  </table>
               </div>

               <div class="glass-card p-6 border border-yellow-600/30">
                  <h3 class="font-bold mb-4 text-yellow-500"><i class="fa-solid fa-warehouse mr-2"></i> Inventory Generator</h3>
                  <div class="space-y-3">
                     <div class="flex gap-2">
                        <div class="flex-1"><label class="text-xs text-gray-500">Rack Prefix</label><input v-model="inv.prefix" placeholder="A" class="glass-input w-full p-2 rounded"></div>
                        <div class="flex-1"><label class="text-xs text-gray-500">Almirahs</label><input v-model="inv.almirahCount" type="number" class="glass-input w-full p-2 rounded"></div>
                     </div>
                     <div class="flex gap-2">
                        <div class="flex-1"><label class="text-xs text-gray-500">Rows</label><input v-model="inv.rows" type="number" class="glass-input w-full p-2 rounded"></div>
                        <div class="flex-1"><label class="text-xs text-gray-500">Cols</label><input v-model="inv.cols" type="number" class="glass-input w-full p-2 rounded"></div>
                     </div>
                     <button @click="generateInventory" class="w-full py-2 bg-yellow-700 hover:bg-yellow-600 rounded font-bold text-white mt-2">Auto-Generate Locations</button>
                  </div>
                  <div class="mt-4 text-xs text-gray-400">Total Locations: {{ db.locations.length }}</div>
               </div>
            </div>
         </div>
      </main>

      <div v-if="modal.show" class="fixed inset-0 bg-black/80 z-50 flex items-center justify-center">
         <div class="glass-card p-8 w-full max-w-lg slide-up">
            <h3 class="text-xl font-bold mb-6 text-white capitalize">{{ modal.mode }} {{ modal.type }}</h3>
            
            <div v-if="modal.type==='cat'" class="space-y-4">
               <input v-model="forms.cat.Name" placeholder="Category Name" class="glass-input w-full p-3 rounded-xl">
               <input v-model="forms.cat.Icon" placeholder="Icon (fa-solid fa-folder)" class="glass-input w-full p-3 rounded-xl">
            </div>

            <div v-if="modal.type==='con'" class="space-y-4">
               <input v-model="forms.con.FirmName" placeholder="Firm Name" class="glass-input w-full p-3 rounded-xl">
               <input v-model="forms.con.AgreementNo" placeholder="Agreement No" class="glass-input w-full p-3 rounded-xl">
               <div class="flex gap-4"><input type="date" v-model="forms.con.StartDate" class="glass-input w-1/2 p-3 rounded-xl"><input type="date" v-model="forms.con.EndDate" class="glass-input w-1/2 p-3 rounded-xl"></div>
               <textarea v-model="forms.con.Description" placeholder="Details" class="glass-input w-full p-3 rounded-xl h-20"></textarea>
               <select v-model="forms.con.Status" class="glass-input w-full p-3 rounded-xl"><option>Active</option><option>Expired</option></select>
            </div>

            <div v-if="modal.type==='file'" class="space-y-4">
               <div class="grid grid-cols-2 gap-4">
                  <input v-model="forms.file.FileNo" placeholder="File No." class="glass-input p-3 rounded-xl">
                  <input v-model="forms.file.Name" placeholder="Name" class="glass-input p-3 rounded-xl">
                  <select v-model="forms.file.Type" class="glass-input p-3 rounded-xl" :disabled="forms.file.ParentFileID">
                     <option>Pink File</option><option>Brown File</option><option>White Backing</option><option>Register</option><option>Sub-File</option><option>Custom</option>
                  </select>
                  <select v-model="forms.file.Location" class="glass-input p-3 rounded-xl"><option v-for="l in db.locations" :value="l">{{ l }}</option></select>
                  <input v-model="forms.file.PageCount" placeholder="Pages" class="glass-input p-3 rounded-xl">
                  <select v-model="forms.file.Status" class="glass-input p-3 rounded-xl"><option>Active</option><option>Archived</option></select>
               </div>
               <textarea v-model="forms.file.Description" placeholder="Description" class="glass-input w-full p-3 rounded-xl h-20"></textarea>
               <input v-if="modal.mode==='create'" type="file" @change="upload" class="text-gray-400 text-sm">
            </div>

            <div v-if="modal.type==='user'" class="space-y-4">
               <input v-model="forms.user.name" placeholder="Full Name" class="glass-input w-full p-3 rounded-xl">
               <div class="flex gap-4">
                  <input v-model="forms.user.username" placeholder="Username" class="glass-input w-1/2 p-3 rounded-xl">
                  <input v-model="forms.user.email" placeholder="Email" class="glass-input w-1/2 p-3 rounded-xl">
               </div>
               <input v-model="forms.user.password" placeholder="Password" class="glass-input w-full p-3 rounded-xl">
               <select v-model="forms.user.role" class="glass-input w-full p-3 rounded-xl"><option>Manager</option><option>Admin</option></select>
            </div>

            <div class="flex justify-end gap-4 mt-6">
               <button @click="modal.show=false" class="px-4 py-2 text-gray-400">Cancel</button>
               <button @click="saveItem" class="px-6 py-2 btn-gradient rounded-xl font-bold text-white">Save</button>
            </div>
         </div>
      </div>

    </div>
  </div>

  <script>
    const API = "https://fms1.clickworld.workers.dev"; 

    const { createApp } = Vue;
    createApp({
      data() {
        return {
          loading: false, notify: null, page: 'login', view: 'home', authForm: { email: '', password: '' }, user: null,
          search: '', showSuggestions: false,
          db: { categories: [], contracts: [], files: [], locations: [], adminUsers: [] },
          selectedCat: null, selectedCon: null,
          modal: { show: false, type: '', mode: '' },
          forms: { cat: {}, con: {}, file: {}, user: {} },
          inv: { prefix: 'A', almirahCount: 1, rows: 5, cols: 5 } // Inventory Form
        }
      },
      computed: {
        filteredContracts() {
           let list = this.db.contracts.filter(c => c.CatID === this.selectedCat?.CatID);
           return list;
        },
        parentFiles() {
           return this.db.files.filter(f => f.ConID === this.selectedCon?.ConID && !f.ParentFileID);
        },
        // Smart Search Logic
        searchResults() {
           if(!this.search) return [];
           const q = this.search.toLowerCase();
           let results = [];
           
           // Contracts
           this.db.contracts.forEach(c => {
              if(c.FirmName.toLowerCase().includes(q) || c.AgreementNo.toLowerCase().includes(q)) {
                 results.push({ id: c.ConID, title: c.FirmName, subtitle: `Contract: ${c.AgreementNo}`, type: 'Contract', data: c });
              }
           });
           // Files
           this.db.files.forEach(f => {
              if(f.Name.toLowerCase().includes(q) || f.FileNo.toLowerCase().includes(q)) {
                 results.push({ id: f.FileID, title: f.Name, subtitle: `File No: ${f.FileNo}`, type: 'File', data: f });
              }
           });
           return results.slice(0, 10);
        }
      },
      methods: {
        async api(action, payload={}) {
           this.loading = true;
           try {
             const res = await fetch(API, { method: 'POST', body: JSON.stringify({action, payload}) });
             this.loading = false; return await res.json();
           } catch(e) { this.loading=false; this.toast("Error", "error"); return {success:false}; }
        },
        async auth() {
           const res = await this.api('login', this.authForm);
           if(res.success) { this.user = res.user; this.page='app'; this.loadData(); } else this.toast(res.msg, 'error');
        },
        async loadData() {
           const res = await this.api('getDashboard', { role: this.user.role });
           if(res.success) this.db = res.data;
        },
        navigate(v) { this.view=v; this.selectedCat=null; this.selectedCon=null; },
        selectCat(c) { this.selectedCat=c; },
        selectCon(c) { this.selectedCon=c; },
        getContractCount(id) { return this.db.contracts.filter(c=>c.CatID===id).length; },
        getSubFiles(parentId) { return this.db.files.filter(f => f.ParentFileID === parentId); },

        // Search Selection
        handleSearchSelect(res) {
           this.search = '';
           this.showSuggestions = false;
           if(res.type === 'Contract') {
              // Find Category for this contract
              const cat = this.db.categories.find(c => c.CatID === res.data.CatID);
              this.selectedCat = cat;
              this.selectedCon = res.data;
              this.view = 'home';
           } else if(res.type === 'File') {
              // Find Contract and Category
              const con = this.db.contracts.find(c => c.ConID === res.data.ConID);
              const cat = this.db.categories.find(c => c.CatID === con.CatID);
              this.selectedCat = cat;
              this.selectedCon = con;
              this.view = 'home';
              // Optional: Scroll to file logic here
           }
        },

        // GENERIC MODAL HANDLER
        openModal(type, mode, data={}) {
           this.modal = { show: true, type, mode };
           if(mode==='create') {
              if(type==='file') this.forms.file = { Type: 'Pink File', Status: 'Active', Location: this.db.locations[0], ConID: this.selectedCon?.ConID };
              else if(type==='con') this.forms.con = { Status: 'Active', CatID: this.selectedCat?.CatID };
              else if(type==='cat') this.forms.cat = {};
              else if(type==='user') this.forms.user = { role: 'Manager' };
           } else {
              this.forms[type] = { ...data };
           }
        },
        openSubFileModal(parentFile) {
           this.modal = { show: true, type: 'file', mode: 'create' };
           this.forms.file = { Type: 'Sub-File', Status: 'Active', Location: parentFile.Location, ConID: this.selectedCon.ConID, ParentFileID: parentFile.FileID };
        },

        async saveItem() {
           const type = this.modal.type;
           const action = type==='cat'?'manageCategory': type==='con'?'manageContract': type==='file'?'manageFile': 'manageUser';
           if(type==='file' && this.modal.mode==='create') this.forms.file.QR_Data = window.location.origin + window.location.pathname + `?id=FILE-${Date.now()}`;

           const res = await this.api(action, { type: this.modal.mode, data: this.forms[type], row: this.forms[type].rowIndex, user: this.user.name });
           if(res.success) { this.toast("Saved!", "success"); this.modal.show=false; this.loadData(); } else this.toast(res.msg, 'error');
        },
        async deleteItem(action, rowIndex) {
           if(!confirm("Are you sure?")) return;
           const res = await this.api(action, { type: 'delete', row: rowIndex });
           if(res.success) { this.toast("Deleted", "success"); this.loadData(); }
        },
        async generateInventory() {
           const res = await this.api('generateInventory', { data: this.inv });
           if(res.success) { this.toast(`Generated ${res.count} Locations!`, "success"); this.loadData(); }
        },

        upload(e) { const f=e.target.files[0]; const r=new FileReader(); r.onload=ev=>{this.forms.file.fileData=ev.target.result.split(',')[1]; this.forms.file.mime=f.type; this.forms.file.fileName=f.name;}; r.readAsDataURL(f); },
        downloadQR(f) {
           const canvas = document.createElement('canvas');
           const qr = new QRious({ element: canvas, value: f.QR_Data, size: 500 });
           const link = document.createElement('a');
           link.download = `QR_${f.FileNo}.png`;
           link.href = canvas.toDataURL("image/png");
           link.click();
        },
        toast(msg, type) { this.notify = { msg, type }; setTimeout(()=>this.notify=null, 3000); },
        logout() { location.reload(); }
      }
    }).mount('#app');
  </script>
</body>
</html>
