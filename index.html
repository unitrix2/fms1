<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Railway CBT Mock Test Portal</title>
    
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>

    <style>
        :root { 
            --primary: #b71c1c; --primary-dark: #7f0000;
            --secondary: #eceff1; --text: #263238; 
            --correct: #2e7d32; --wrong: #c62828; 
            --review: #7b1fa2; --current: #ff9800;
        }
        
        body { font-family: 'Segoe UI', sans-serif; margin: 0; background: var(--secondary); color: var(--text); height: 100vh; display: flex; flex-direction: column; overflow: hidden; }

        /* --- LOGIN PAGE --- */
        #login-page { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: radial-gradient(circle, #0d47a1 0%, #000 100%); z-index: 10000; display: flex; justify-content: center; align-items: center; }
        .login-card { background: rgba(255,255,255,0.1); backdrop-filter: blur(15px); padding: 30px; border-radius: 20px; width: 350px; text-align: center; border: 1px solid rgba(255,255,255,0.2); color: white; }
        .input-group input { width: 100%; padding: 12px; margin: 10px 0; border-radius: 8px; border: none; box-sizing: border-box; }
        .login-btn { width: 100%; padding: 12px; background: var(--primary); color: white; border: none; border-radius: 50px; cursor: pointer; font-weight: bold; }

        /* --- HEADER --- */
        #app-content { display: none; height: 100%; flex-direction: column; }
        header { background: white; padding: 10px 20px; display: flex; justify-content: space-between; align-items: center; border-bottom: 3px solid var(--primary); box-shadow: 0 2px 10px rgba(0,0,0,0.1); z-index: 100; }
        .header-left { display: flex; align-items: center; gap: 15px; }
        .header-title h2 { margin: 0; color: var(--primary); font-size: 1.2rem; text-transform: uppercase; }
        .user-tools { display: flex; align-items: center; gap: 15px; }
        .theme-dot { width: 15px; height: 15px; border-radius: 50%; cursor: pointer; border: 1px solid #ccc; }

        /* --- DASHBOARD --- */
        #dashboard { flex: 1; padding: 20px; overflow-y: auto; }
        .role-filter { margin-bottom: 20px; background: white; padding: 15px; border-radius: 10px; display: flex; align-items: center; gap: 10px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .test-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(320px, 1fr)); gap: 15px; }
        .test-card { background: white; padding: 20px; border-radius: 10px; border-left: 6px solid var(--primary); box-shadow: 0 2px 5px rgba(0,0,0,0.05); display: flex; justify-content: space-between; align-items: center; cursor: pointer; }
        .test-card:hover { transform: translateY(-2px); box-shadow: 0 5px 15px rgba(0,0,0,0.1); }
        
        /* --- ADMIN TABS --- */
        .admin-nav { display: flex; gap: 10px; margin-bottom: 20px; border-bottom: 2px solid #ddd; }
        .adm-tab { padding: 10px 20px; cursor: pointer; font-weight: bold; border-bottom: 3px solid transparent; }
        .adm-tab.active { color: var(--primary); border-bottom-color: var(--primary); }

        /* --- QUIZ UI --- */
        #quiz-view { display: none; height: 100%; flex: 1; gap: 15px; padding: 15px; box-sizing: border-box; background: #f1f3f4; }
        .quiz-main { flex: 3; background: white; border-radius: 12px; display: flex; flex-direction: column; overflow: hidden; box-shadow: 0 4px 15px rgba(0,0,0,0.05); }
        .quiz-header { padding: 15px 25px; background: #f8f9fa; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; align-items: center; }
        .timer { font-family: monospace; font-size: 1.5rem; font-weight: bold; color: var(--primary); }
        .q-body { flex: 1; padding: 30px; overflow-y: auto; }
        .q-text-en { font-size: 1.3rem; font-weight: 600; margin-bottom: 10px; }
        .q-text-hi { font-size: 1.15rem; color: #455a64; margin-bottom: 25px; font-family: 'Nirmala UI', sans-serif; }
        .option-box { display: block; padding: 15px; border: 2px solid #eee; border-radius: 10px; margin-bottom: 10px; cursor: pointer; transition: 0.2s; }
        .option-box:hover { border-color: var(--primary); background: #f9f9f9; }
        .option-box input { margin-right: 15px; transform: scale(1.4); accent-color: var(--primary); }
        
        .quiz-footer { padding: 15px 25px; background: white; border-top: 1px solid #eee; display: flex; justify-content: space-between; }
        .btn { padding: 10px 25px; border: none; border-radius: 6px; cursor: pointer; font-weight: bold; color: white; text-transform: uppercase; }

        /* --- PALETTE --- */
        .quiz-sidebar { flex: 1; max-width: 300px; background: white; border-radius: 12px; padding: 20px; display: flex; flex-direction: column; box-shadow: 0 4px 15px rgba(0,0,0,0.05); }
        .palette-grid { display: grid; grid-template-columns: repeat(5, 1fr); gap: 8px; overflow-y: auto; margin-top: 15px; }
        .p-btn { padding: 10px 0; text-align: center; border: 1px solid #ddd; border-radius: 6px; cursor: pointer; font-weight: bold; }
        .p-btn.done { background: var(--primary); color: white; border-color: var(--primary); }
        .p-btn.review { background: var(--review); color: white; border-color: var(--review); }
        .p-btn.curr { border: 2px solid var(--current); }

        /* --- PRINT BOOKLET --- */
        @media print {
            body * { visibility: hidden; }
            #print-section, #print-section * { visibility: visible; }
            #print-section { position: absolute; left: 0; top: 0; width: 100%; padding: 20px; }
            .print-q { margin-bottom: 25px; border-bottom: 1px dashed #aaa; padding-bottom: 15px; break-inside: avoid; }
            .print-key { break-before: page; text-align: center; }
        }
    </style>
</head>
<body>

<div id="login-page">
    <div class="login-card">
        <img src="https://images.seeklogo.com/logo-png/31/1/indian-railways-logo-png_seeklogo-310214.png" width="70">
        <h2>LDCE MOCK TEST</h2>
        <div class="input-group"><input type="text" id="username" placeholder="Username / PF Number"></div>
        <div class="input-group"><input type="password" id="password" placeholder="Password"></div>
        <button class="login-btn" onclick="handleManualLogin()">Login</button>
        <div style="margin: 15px 0;">OR</div>
        <button class="login-btn" style="background:white; color:#333;" onclick="handleGoogleLogin()">Sign in with Google</button>
        <p id="login-err" style="color:yellow; font-size:0.8rem; margin-top:10px;"></p>
    </div>
</div>

<div id="app-content">
    <header>
        <div class="header-left">
            <img src="https://images.seeklogo.com/logo-png/31/1/indian-railways-logo-png_seeklogo-310214.png" width="40">
            <div class="header-title"><h2 id="portal-title">LDCE Portal</h2></div>
        </div>
        <div class="user-tools">
            <div style="display:flex; gap:5px;">
                <div class="theme-dot" style="background:#b71c1c" onclick="setTheme('#b71c1c')"></div>
                <div class="theme-dot" style="background:#1565c0" onclick="setTheme('#1565c0')"></div>
                <div class="theme-dot" style="background:#2e7d32" onclick="setTheme('#2e7d32')"></div>
            </div>
            <span id="user-display" style="font-weight:bold; color:#555;">User</span>
            <button class="btn" style="background:#eee; color:#333; padding:5px 10px;" onclick="logout()">Logout</button>
        </div>
    </header>

    <div id="dashboard">
        <div id="role-selector-box" class="role-filter" style="display:none;">
            <b>Select Category:</b>
            <select id="role-dropdown" style="padding:8px; border-radius:5px;" onchange="loadTestsForCategory(this.value)">
                </select>
        </div>

        <div id="admin-tabs" class="admin-nav" style="display:none;">
            <div class="adm-tab active" onclick="switchAdminTab('tests')">All Tests</div>
            <div class="adm-tab" onclick="switchAdminTab('reports')">Reported Issues</div>
            <div class="adm-tab" onclick="switchAdminTab('users')">Manage Access</div>
        </div>

        <div id="test-list-grid" class="test-grid"></div>
        <div id="reports-view" style="display:none;">
            <table style="width:100%; background:white; border-radius:10px;">
                <thead><tr style="background:#eee;"><th>Test</th><th>Q#</th><th>Issue</th><th>User</th><th>Action</th></tr></thead>
                <tbody id="reports-body"></tbody>
            </table>
        </div>
    </div>

    <div id="quiz-view">
        <div class="quiz-main">
            <div class="quiz-header">
                <button class="btn" style="background:#607d8b" onclick="exitTest()">Exit</button>
                <span id="active-paper-name" style="font-weight:bold;">Paper Name</span>
                <div class="timer" id="timer-display">00:00:00</div>
            </div>
            <div class="q-body" id="question-container"></div>
            <div class="quiz-footer">
                <button class="btn" style="background:#90a4ae" onclick="navQuestion(-1)">Previous</button>
                <button class="btn" style="background:var(--review)" onclick="markReview()">Review Later</button>
                <button class="btn" style="background:var(--primary)" onclick="navQuestion(1)">Next</button>
                <button class="btn" style="background:var(--correct)" onclick="submitTest()">Finish Test</button>
            </div>
        </div>
        <div class="quiz-sidebar">
            <h4 style="margin:0;">Palette</h4>
            <div class="palette-grid" id="palette-grid"></div>
            <button class="btn" style="background:#ff9800; margin-top:20px;" onclick="reportQuestion()">Report Error</button>
        </div>
    </div>
</div>

<div id="print-section"></div>

<script>
    // --- CONFIG ---
    const GH_U = 'unitrix2', GH_R = 'fms1';
    const firebaseConfig = {
        apiKey: "AIzaSyCxCLczt1L01qr3DmdvAv_EU3IsWhgxs0w",
        authDomain: "fms1-39dca.firebaseapp.com",
        projectId: "fms1-39dca",
        storageBucket: "fms1-39dca.firebasestorage.app",
        messagingSenderId: "46968102286",
        appId: "1:46968102286:web:452d87de53dfcc2028d8df"
    };
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth(), db = firebase.firestore(), googleProvider = new firebase.auth.GoogleAuthProvider();

    let user = null, currentData = [], answers = {}, review = {}, qIdx = 0, seconds = 0, timerInt = null;

    // --- AUTHENTICATION ---
    async function handleManualLogin() {
        const u = document.getElementById('username').value, p = document.getElementById('password').value;
        const res = await fetch('users.json');
        const users = await res.json();
        const found = users.find(x => x.username === u && x.password === p);
        if(found) validateAccess(found, 'manual');
        else document.getElementById('login-err').innerText = "Incorrect Credentials";
    }

    function handleGoogleLogin() {
        auth.signInWithPopup(googleProvider).then(res => validateAccess(res.user.email, 'google'));
    }

    async function validateAccess(cred, type) {
        let email = type === 'google' ? cred : cred.username;
        let roles = [], name = "User";

        if(type === 'google') {
            const res = await fetch('allowed_users.json');
            const allowed = await res.json();
            const found = allowed.find(x => x.email.toLowerCase() === email.toLowerCase());
            if(found) { roles = found.access; name = email.split('@')[0]; }
        } else {
            roles = cred.access; name = cred.name;
        }

        if(roles.length > 0) {
            user = { name, email, roles };
            sessionStorage.setItem('cbt_user', JSON.stringify(user));
            setupApp();
        } else {
            alert("No Permission Found."); auth.signOut();
        }
    }

    // --- INITIALIZE APP ---
    function setupApp() {
        document.getElementById('login-page').style.display = 'none';
        document.getElementById('app-content').style.display = 'flex';
        document.getElementById('user-display').innerText = user.name;

        // Dynamic Title
        const roles = user.roles.includes('admin') ? "Super Admin" : user.roles.map(r => r.toUpperCase()).join(' / ');
        document.getElementById('portal-title').innerText = `LDCE ${roles} (C&W) Portal`;

        // Role Selector Visibility
        const drop = document.getElementById('role-dropdown');
        const box = document.getElementById('role-selector-box');
        
        let categories = user.roles.includes('admin') ? ['tech-iii', 'je', 'adme'] : user.roles;
        
        if(categories.length > 1) {
            box.style.display = 'flex';
            drop.innerHTML = '<option value="">-- Select Post --</option>';
            categories.forEach(c => drop.innerHTML += `<option value="${c}">${c.toUpperCase()}</option>`);
        } else {
            loadTestsForCategory(categories[0]);
        }

        if(user.roles.includes('admin')) document.getElementById('admin-tabs').style.display = 'flex';

        // Resume Test Check
        const saved = localStorage.getItem('cbt_resume_' + user.email);
        if(saved) {
            if(confirm("Complete your unfinished test?")) resumeTest(JSON.parse(saved));
            else localStorage.removeItem('cbt_resume_' + user.email);
        }
    }

    // --- LOADING PAPERS ---
    async function loadTestsForCategory(cat) {
        if(!cat) return;
        const grid = document.getElementById('test-list-grid');
        grid.innerHTML = "Fetching papers...";
        try {
            const res = await fetch(`https://api.github.com/repos/${GH_U}/${GH_R}/contents/tests/${cat}`);
            const files = await res.json();
            grid.innerHTML = "";
            files.filter(f => f.name.endsWith('.json')).forEach(f => {
                const name = f.name.replace('.json','').replace(/_/g,' ').toUpperCase();
                const card = document.createElement('div');
                card.className = "test-card";
                card.innerHTML = `
                    <div style="flex:1" onclick="startPaper('${f.download_url}', '${name}')">
                        <b>${name}</b><br><small>Click to Start ‚ûî</small>
                    </div>
                    ${user.roles.includes('admin') ? `<button class="btn" style="background:#333; padding:5px;" onclick="printBooklet('${f.download_url}','${name}')">üñ®Ô∏è</button>` : ''}
                `;
                grid.appendChild(card);
            });
        } catch(e) { grid.innerHTML = "No tests found in this folder."; }
    }

    // --- QUIZ LOGIC ---
    async function startPaper(url, name) {
        const res = await fetch(url);
        currentData = await res.json();
        answers = {}; review = {}; qIdx = 0; seconds = 0;
        initQuizUI(name);
    }

    function resumeTest(data) {
        currentData = data.currentData;
        answers = data.answers;
        review = data.review;
        qIdx = data.qIdx;
        seconds = data.seconds;
        initQuizUI(data.name);
    }

    function initQuizUI(name) {
        document.getElementById('dashboard').style.display = 'none';
        document.getElementById('quiz-view').style.display = 'flex';
        document.getElementById('active-paper-name').innerText = name;
        renderQuestion();
        renderPalette();
        startTimer();
    }

    function renderQuestion() {
        const q = currentData[qIdx];
        let html = `<div class="q-text-en">Q${qIdx+1}. ${q.q}</div>`;
        if(q.h) html += `<div class="q-text-hi">${q.h}</div>`;
        html += `<div style="margin-top:20px;">`;
        q.o.forEach((opt, i) => {
            const chk = answers[qIdx] === i ? 'checked' : '';
            html += `<label class="option-box"><input type="radio" name="opt" onclick="saveAns(${i})" ${chk}> ${opt}</label>`;
        });
        document.getElementById('question-container').innerHTML = html + "</div>";
        updatePalette();
        
        // Auto Save to LocalStorage for Resume
        localStorage.setItem('cbt_resume_' + user.email, JSON.stringify({
            currentData, answers, review, qIdx, seconds, name: document.getElementById('active-paper-name').innerText
        }));
    }

    function saveAns(i) { answers[qIdx] = i; updatePalette(); }
    function markReview() { review[qIdx] = !review[qIdx]; updatePalette(); }
    function navQuestion(d) { if(qIdx+d >= 0 && qIdx+d < currentData.length) { qIdx+=d; renderQuestion(); } }

    function renderPalette() {
        const grid = document.getElementById('palette-grid');
        grid.innerHTML = "";
        currentData.forEach((_, i) => {
            grid.innerHTML += `<div id="pal-${i}" class="p-btn" onclick="jumpTo(${i})">${i+1}</div>`;
        });
        updatePalette();
    }

    function updatePalette() {
        currentData.forEach((_, i) => {
            const el = document.getElementById(`pal-${i}`);
            el.className = 'p-btn';
            if(answers[i] !== undefined) el.classList.add('done');
            if(review[i]) el.classList.add('review');
            if(i === qIdx) el.classList.add('curr');
        });
    }

    function jumpTo(i) { qIdx = i; renderQuestion(); }

    function startTimer() {
        clearInterval(timerInt);
        timerInt = setInterval(() => {
            seconds++;
            const h = Math.floor(seconds/3600).toString().padStart(2,'0');
            const m = Math.floor((seconds%3600)/60).toString().padStart(2,'0');
            const s = (seconds%60).toString().padStart(2,'0');
            document.getElementById('timer-display').innerText = `${h}:${m}:${s}`;
        }, 1000);
    }

    function exitTest() { if(confirm("Discard test and exit?")) { clearInterval(timerInt); location.reload(); } }

    function submitTest() {
        if(!confirm("Are you sure you want to finish?")) return;
        clearInterval(timerInt);
        localStorage.removeItem('cbt_resume_' + user.email);
        let score = 0;
        currentData.forEach((q, i) => { if(answers[i] === q.c) score++; });
        
        // Save to Firebase for Results
        db.collection('results').add({
            user: user.email, name: user.name, 
            test: document.getElementById('active-paper-name').innerText,
            score, total: currentData.length, date: new Date()
        });

        alert(`Submitted! Score: ${score} / ${currentData.length}`);
        location.reload();
    }

    // --- ADMIN ACTIONS ---
    async function printBooklet(url, name) {
        const res = await fetch(url);
        const data = await res.json();
        let html = `<h1 style="text-align:center;">${name}</h1><hr>`;
        let key = `<div class="print-key"><h2>Answer Key</h2><div style="display:grid; grid-template-columns:repeat(5,1fr);">`;
        
        data.forEach((q, i) => {
            html += `<div class="print-q"><b>Q${i+1}. ${q.q}</b><br><i>${q.h||''}</i>`;
            html += `<div style="display:grid; grid-template-columns:1fr 1fr; margin-top:10px;">`;
            q.o.forEach((o, idx) => html += `<div>(${String.fromCharCode(65+idx)}) ${o}</div>`);
            html += `</div></div>`;
            key += `<div>${i+1}: <b>${String.fromCharCode(65+q.c)}</b></div>`;
        });

        document.getElementById('print-section').innerHTML = html + key + "</div></div>";
        window.print();
        document.getElementById('print-section').innerHTML = "";
    }

    function reportQuestion() {
        const msg = prompt("Describe the error in this question:");
        if(msg) {
            db.collection('reports').add({
                test: document.getElementById('active-paper-name').innerText,
                qIdx: qIdx + 1,
                msg, user: user.email, date: new Date()
            }).then(() => alert("Reported to Admin."));
        }
    }

    function switchAdminTab(t) {
        document.querySelectorAll('.adm-tab').forEach(x => x.classList.remove('active'));
        event.target.classList.add('active');
        document.getElementById('test-list-grid').style.display = t === 'tests' ? 'grid' : 'none';
        document.getElementById('reports-view').style.display = t === 'reports' ? 'block' : 'none';
        if(t === 'reports') loadReports();
    }

    async function loadReports() {
        const snap = await db.collection('reports').orderBy('date','desc').get();
        const body = document.getElementById('reports-body');
        body.innerHTML = "";
        snap.forEach(doc => {
            const d = doc.data();
            body.innerHTML += `<tr style="border-bottom:1px solid #eee;">
                <td style="padding:10px;">${d.test}</td><td>${d.qIdx}</td><td>${d.msg}</td><td>${d.user}</td>
                <td><button onclick="deleteReport('${doc.id}')">Resolve</button></td></tr>`;
        });
    }

    function deleteReport(id) { db.collection('reports').doc(id).delete().then(loadReports); }

    function setTheme(c) { document.documentElement.style.setProperty('--primary', c); }
    function logout() { sessionStorage.clear(); auth.signOut(); location.reload(); }

    // Init Session
    const savedUser = sessionStorage.getItem('cbt_user');
    if(savedUser) { user = JSON.parse(savedUser); setupApp(); }
</script>

</body>
</html>
