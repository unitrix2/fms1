<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Aurora FMS | Intelligent</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrious/4.0.2/qrious.min.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
  
  <script>
    tailwind.config = {
      darkMode: 'class',
      theme: { extend: { colors: { glass: "rgba(255, 255, 255, 0.05)", glassDark: "rgba(0, 0, 0, 0.4)" } } }
    }
  </script>

  <style>
    body { font-family: 'Inter', sans-serif; transition: background-color 0.3s, color 0.3s; }
    
    /* THEME VARIABLES */
    .theme-dark { --bg-grad-1: rgba(88, 28, 135, 0.4); --bg-grad-2: rgba(236, 72, 153, 0.3); --text-main: #fff; --text-sec: #9ca3af; --glass-border: rgba(255,255,255,0.1); --panel-bg: rgba(20,20,20,0.6); }
    .theme-light { --bg-grad-1: rgba(59, 130, 246, 0.2); --bg-grad-2: rgba(147, 51, 234, 0.2); --text-main: #1f2937; --text-sec: #4b5563; --glass-border: rgba(0,0,0,0.1); --panel-bg: rgba(255,255,255,0.7); }

    /* BACKGROUND ANIMATION */
    .aurora-bg { position: fixed; inset: 0; z-index: -1; filter: blur(80px); transition: 0.5s; }
    .dark .aurora-bg { background: #0f172a; background-image: radial-gradient(circle at 10% 20%, var(--bg-grad-1), transparent 40%), radial-gradient(circle at 90% 80%, var(--bg-grad-2), transparent 40%); }
    .light .aurora-bg { background: #f8fafc; background-image: radial-gradient(circle at 50% 50%, var(--bg-grad-1), transparent 50%), radial-gradient(circle at 10% 90%, var(--bg-grad-2), transparent 50%); }

    /* GLASS COMPONENTS */
    .glass-card {
      background: var(--panel-bg); backdrop-filter: blur(24px); -webkit-backdrop-filter: blur(24px);
      border: 1px solid var(--glass-border); box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.1); border-radius: 16px; transition: 0.3s;
    }
    .glass-input {
      background: rgba(125, 125, 125, 0.1); border: 1px solid var(--glass-border);
      color: var(--text-main); transition: 0.3s;
    }
    .glass-input:focus { border-color: #d946ef; outline: none; box-shadow: 0 0 0 2px rgba(217, 70, 239, 0.2); }

    /* File Types Borders */
    .type-Pink { border-left: 4px solid #ec4899; }
    .type-Brown { border-left: 4px solid #d97706; }
    .type-White { border-left: 4px solid #94a3b8; }
    .type-Register { border-left: 4px solid #3b82f6; }
    .type-Sub { border-left: 4px solid #8b5cf6; margin-left: 20px; }

    /* Animations */
    .slide-enter-active, .slide-leave-active { transition: transform 0.3s ease; }
    .slide-enter-from, .slide-leave-to { transform: translateX(100%); }
    .fade-enter-active, .fade-leave-active { transition: opacity 0.3s; }
    .fade-enter-from, .fade-leave-to { opacity: 0; }
    
    .btn-gradient { background: linear-gradient(135deg, #7c3aed, #db2777); color: white; }
    .btn-gradient:hover { filter: brightness(1.1); transform: translateY(-1px); }
  </style>
</head>
<body :class="isDark ? 'dark theme-dark' : 'light theme-light'" class="text-[var(--text-main)]">
  
  <div class="aurora-bg"></div>
  
  <div id="app" class="min-h-screen flex flex-col relative z-10 text-sm md:text-base">
    
    <transition name="fade"><div v-if="notify" :class="`fixed top-6 right-6 px-6 py-4 rounded-xl shadow-2xl glass-card z-[60] flex items-center gap-3 border-l-4 ${notify.type==='error'?'border-red-500':'border-green-400'}`"><i class="fa-solid fa-bell"></i> <span class="font-bold">{{ notify.msg }}</span></div></transition>
    
    <div v-if="loading" class="fixed inset-0 bg-black/80 z-[70] flex flex-col items-center justify-center backdrop-blur-sm"><div class="w-16 h-16 border-4 border-t-purple-500 border-r-pink-500 border-b-blue-500 border-l-transparent rounded-full animate-spin"></div><div class="mt-4 font-bold text-white tracking-widest animate-pulse">SYSTEM PROCESSING</div></div>

    <div v-if="page === 'login'" class="flex-grow flex items-center justify-center p-4">
      <div class="glass-card p-10 rounded-3xl w-full max-w-md animate-fade-in-up">
        <div class="text-center mb-8">
           <h1 class="text-4xl font-extrabold bg-clip-text text-transparent bg-gradient-to-r from-purple-500 to-pink-500">AURORA</h1>
           <p class="text-[var(--text-sec)] text-xs tracking-[0.3em] uppercase mt-2">Enterprise File System</p>
        </div>
        <form @submit.prevent="auth">
           <label class="text-xs font-bold text-[var(--text-sec)] ml-1">IDENTITY</label>
           <input v-model="authForm.email" placeholder="Username / Email" class="glass-input w-full p-3 rounded-xl mb-4" required>
           <label class="text-xs font-bold text-[var(--text-sec)] ml-1">ACCESS KEY</label>
           <input v-model="authForm.password" type="password" placeholder="Password" class="glass-input w-full p-3 rounded-xl mb-6" required>
           <button class="w-full py-3.5 btn-gradient rounded-xl font-bold shadow-lg tracking-wide">SECURE LOGIN</button>
        </form>
      </div>
    </div>

    <div v-else class="flex h-screen overflow-hidden">
      <aside class="w-64 glass-card m-4 mr-0 flex flex-col hidden md:flex">
         <div class="p-6 border-b border-[var(--glass-border)]">
            <h2 class="text-2xl font-bold bg-clip-text text-transparent bg-gradient-to-r from-blue-400 to-purple-500">AURORA</h2>
            <div class="text-xs text-[var(--text-sec)] mt-1">@{{ user.username }} <span class="bg-purple-500/20 text-purple-500 px-1 rounded">{{ user.role }}</span></div>
         </div>
         <nav class="p-4 space-y-2 flex-1">
            <button @click="navigate('home')" :class="`w-full text-left p-3 rounded-xl flex items-center gap-3 transition ${view==='home'?'bg-purple-500/10 border border-purple-500/30 text-purple-500 font-bold':'text-[var(--text-sec)] hover:bg-[var(--glass-border)]'}`"><i class="fa-solid fa-layer-group w-5 text-center"></i> Categories</button>
            <button v-if="user.role==='Admin'" @click="view='admin'" :class="`w-full text-left p-3 rounded-xl flex items-center gap-3 transition ${view==='admin'?'bg-purple-500/10 border border-purple-500/30 text-purple-500 font-bold':'text-[var(--text-sec)] hover:bg-[var(--glass-border)]'}`"><i class="fa-solid fa-shield-cat w-5 text-center"></i> Admin Panel</button>
         </nav>
         
         <div class="px-6 py-2 flex justify-between items-center text-[var(--text-sec)]">
            <span class="text-xs font-bold">THEME</span>
            <button @click="isDark = !isDark" class="p-2 rounded-full hover:bg-[var(--glass-border)] transition">
               <i :class="isDark ? 'fa-solid fa-sun text-yellow-400' : 'fa-solid fa-moon text-blue-600'"></i>
            </button>
         </div>

         <div class="p-4 border-t border-[var(--glass-border)]">
            <button @click="logout" class="w-full p-3 border border-red-500/30 text-red-500 rounded-xl hover:bg-red-500/10 font-bold transition flex items-center justify-center gap-2"><i class="fa-solid fa-power-off"></i> Logout</button>
         </div>
      </aside>

      <main class="flex-1 overflow-y-auto p-6 relative">
         
         <div class="glass-card p-1 rounded-2xl mb-8 sticky top-0 z-40 shadow-xl flex items-center">
            <div class="p-3 text-[var(--text-sec)]"><i class="fa-solid fa-magnifying-glass text-lg"></i></div>
            <input v-model="search" type="text" placeholder="AI Search: Type File Name, Number, Description, or Contract Firm..." class="bg-transparent w-full p-3 text-[var(--text-main)] outline-none placeholder-gray-500">
            <div v-if="search" @click="search=''" class="p-3 cursor-pointer text-[var(--text-sec)] hover:text-red-400"><i class="fa-solid fa-xmark"></i></div>
         </div>

         <div v-if="view==='home' && !selectedCat" class="animate-fade-in">
            <div class="flex justify-between items-center mb-6">
               <h2 class="text-2xl font-bold">Categories</h2>
               <button @click="openModal('cat', 'create')" class="btn-gradient px-4 py-2 rounded-xl text-xs font-bold uppercase tracking-wide">+ New Category</button>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
               <div v-for="c in db.categories" class="glass-card p-6 relative group hover:scale-[1.02] transition cursor-pointer" @click="selectCat(c)">
                  <div class="w-14 h-14 rounded-2xl bg-gradient-to-br from-purple-500/20 to-blue-500/20 flex items-center justify-center text-2xl text-purple-500 mb-4 shadow-inner"><i :class="c.Icon || 'fa-solid fa-folder'"></i></div>
                  <h3 class="font-bold text-lg mb-1">{{ c.Name }}</h3>
                  <p class="text-xs text-[var(--text-sec)]">{{ getContractCount(c.CatID) }} Active Contracts</p>
                  <div class="absolute top-4 right-4 opacity-0 group-hover:opacity-100 transition flex gap-2">
                     <button @click.stop="openModal('cat', 'edit', c)" class="text-blue-400 hover:text-blue-300"><i class="fa-solid fa-pen"></i></button>
                     <button @click.stop="deleteItem('manageCategory', c.rowIndex)" class="text-red-400 hover:text-red-300"><i class="fa-solid fa-trash"></i></button>
                  </div>
               </div>
            </div>
         </div>

         <div v-if="selectedCat && !selectedCon" class="animate-fade-in">
            <div class="flex items-center gap-2 mb-6 text-[var(--text-sec)] text-sm font-medium">
               <span @click="selectedCat=null" class="hover:text-purple-400 cursor-pointer">Categories</span> <i class="fa-solid fa-chevron-right text-xs"></i> 
               <span class="text-[var(--text-main)]">{{ selectedCat.Name }}</span>
            </div>
            <div class="flex justify-between items-center mb-6">
               <h2 class="text-2xl font-bold">Contracts</h2>
               <button @click="openModal('con', 'create')" class="btn-gradient px-4 py-2 rounded-xl text-xs font-bold uppercase">+ Add Contract</button>
            </div>
            <div class="space-y-3">
               <div v-for="c in filteredContracts" class="glass-card p-5 relative group hover:bg-[var(--glass-border)] transition flex justify-between items-center">
                  <div class="flex-1 cursor-pointer" @click="selectCon(c)">
                     <h3 class="text-xl font-bold">{{ c.FirmName }}</h3>
                     <div class="text-sm text-[var(--text-sec)] mt-1 font-mono">Agmt: {{ c.AgreementNo }} <span class="mx-2">•</span> {{ c.StartDate }} - {{ c.EndDate }}</div>
                  </div>
                  <div class="flex items-center gap-4">
                     <span :class="`px-3 py-1 rounded-full text-xs font-bold ${c.Status==='Active'?'bg-green-500/20 text-green-500':'bg-red-500/20 text-red-500'}`">{{ c.Status }}</span>
                     <div class="opacity-0 group-hover:opacity-100 transition flex gap-3">
                        <button @click="openModal('con', 'edit', c)" class="text-blue-400"><i class="fa-solid fa-pen"></i></button>
                        <button @click="deleteItem('manageContract', c.rowIndex)" class="text-red-400"><i class="fa-solid fa-trash"></i></button>
                     </div>
                  </div>
               </div>
               <div v-if="filteredContracts.length===0" class="text-center py-20 text-[var(--text-sec)]">
                  <i class="fa-solid fa-box-open text-4xl mb-4 opacity-50"></i><br>No Contracts Found.
               </div>
            </div>
         </div>

         <div v-if="selectedCon" class="animate-fade-in pb-20">
            <div class="flex items-center gap-2 mb-6 text-[var(--text-sec)] text-sm font-medium">
               <span @click="selectedCat=null;selectedCon=null" class="hover:text-purple-400 cursor-pointer">Categories</span> <i class="fa-solid fa-chevron-right text-xs"></i> 
               <span @click="selectedCon=null" class="hover:text-purple-400 cursor-pointer">{{ selectedCat.Name }}</span> <i class="fa-solid fa-chevron-right text-xs"></i>
               <span class="text-[var(--text-main)]">{{ selectedCon.FirmName }}</span>
            </div>

            <div class="glass-card p-6 rounded-2xl mb-8 border border-purple-500/30 bg-gradient-to-r from-purple-900/20 to-transparent">
               <div class="flex justify-between items-start">
                  <div>
                     <h1 class="text-3xl font-bold">{{ selectedCon.FirmName }}</h1>
                     <p class="text-[var(--text-sec)] mt-2 max-w-2xl">{{ selectedCon.Description }}</p>
                  </div>
                  <button @click="openModal('file', 'create')" class="btn-gradient px-6 py-3 rounded-xl font-bold shadow-lg flex items-center gap-2"><i class="fa-solid fa-file-circle-plus"></i> NEW FILE</button>
               </div>
            </div>

            <div class="grid gap-4">
               <div v-for="f in parentFiles" :key="f.FileID" :class="`glass-card p-5 relative group ${'type-'+f.Type.split(' ')[0]} transition hover:shadow-lg`">
                  <div class="flex justify-between items-start">
                     <button @click="f.expand = !f.expand" class="mr-3 mt-1 text-[var(--text-sec)] hover:text-[var(--text-main)] transition"><i :class="`fa-solid fa-chevron-${f.expand?'down':'right'}`"></i></button>
                     
                     <div class="flex-1 cursor-pointer" @click="f.expand = !f.expand">
                        <div class="flex items-center gap-3 mb-2">
                           <span class="bg-black/30 px-2 py-1 rounded text-xs font-mono text-[var(--text-sec)] border border-[var(--glass-border)]">{{ f.FileNo }}</span>
                           <span class="text-xs font-bold tracking-wider uppercase text-purple-400">{{ f.Type }}</span>
                           <span :class="`text-xs ${f.Status==='Active'?'text-green-400':'text-red-400'}`">● {{ f.Status }}</span>
                        </div>
                        <h3 class="font-bold text-lg text-[var(--text-main)]">{{ f.Name }}</h3>
                        <p class="text-sm text-[var(--text-sec)] mt-1 line-clamp-2">{{ f.Description }}</p>
                        
                        <div class="mt-3 flex gap-4 text-xs text-[var(--text-sec)]">
                           <span class="bg-[var(--glass-border)] px-2 py-1 rounded"><i class="fa-solid fa-location-dot"></i> {{ f.Location }}</span>
                           <span class="bg-[var(--glass-border)] px-2 py-1 rounded"><i class="fa-solid fa-copy"></i> {{ f.PageCount }} pgs</span>
                        </div>
                     </div>

                     <div class="flex gap-2">
                        <button @click="openQRModal(f)" class="w-9 h-9 rounded-full bg-[var(--glass-border)] hover:bg-white/10 text-[var(--text-main)] flex items-center justify-center transition" title="Show QR"><i class="fa-solid fa-qrcode"></i></button>
                        <button v-if="f.AttachmentURL" @click="openPreview(f)" class="w-9 h-9 rounded-full bg-blue-500/20 text-blue-400 hover:bg-blue-500 hover:text-white flex items-center justify-center transition" title="Preview"><i class="fa-regular fa-eye"></i></button>
                        
                        <div class="flex flex-col gap-2 ml-2 opacity-0 group-hover:opacity-100 transition">
                           <button @click="openModal('file', 'edit', f)" class="text-blue-400 hover:scale-110"><i class="fa-solid fa-pen"></i></button>
                           <button @click="deleteItem('manageFile', f.rowIndex)" class="text-red-400 hover:scale-110"><i class="fa-solid fa-trash"></i></button>
                        </div>
                     </div>
                  </div>

                  <div v-if="f.expand" class="mt-4 pt-4 border-t border-[var(--glass-border)] pl-8">
                     <div class="flex justify-between items-center mb-3">
                        <h4 class="text-xs font-bold text-[var(--text-sec)] uppercase tracking-widest">Sub-Files</h4>
                        <button @click="openSubFileModal(f)" class="text-xs text-purple-400 hover:text-purple-300 border border-purple-500/30 px-3 py-1 rounded hover:bg-purple-500/10 transition">+ Create Sub-File</button>
                     </div>
                     <div v-for="sub in getSubFiles(f.FileID)" class="glass-card p-3 mb-2 flex justify-between items-center bg-[var(--glass-border)] type-Sub">
                        <div class="flex-1 cursor-pointer" @click="openPreview(sub)">
                           <div class="text-sm font-bold text-[var(--text-main)]">{{ sub.Name }} <span class="text-xs font-normal text-[var(--text-sec)] ml-2">({{ sub.Type }})</span></div>
                           <div class="text-xs text-[var(--text-sec)]">{{ sub.FileNo }} • {{ sub.Location }}</div>
                        </div>
                        <div class="flex gap-2">
                           <button v-if="sub.AttachmentURL" @click="openPreview(sub)" class="text-blue-400 text-xs hover:underline">View</button>
                           <button @click="deleteItem('manageFile', sub.rowIndex)" class="text-red-400 text-xs"><i class="fa-solid fa-trash"></i></button>
                        </div>
                     </div>
                     <div v-if="getSubFiles(f.FileID).length===0" class="text-xs text-[var(--text-sec)] italic">No sub-files found.</div>
                  </div>
               </div>
               <div v-if="parentFiles.length===0" class="text-center py-10 text-[var(--text-sec)]">No files found. Try searching or create one.</div>
            </div>
         </div>

         <div v-if="view==='admin'" class="slide-up">
            <h2 class="text-2xl font-bold mb-6">Admin Control</h2>
            <div class="grid md:grid-cols-2 gap-6">
               <div class="glass-card p-6">
                  <div class="flex justify-between mb-4"><h3 class="font-bold">Users</h3><button @click="openModal('user', 'create')" class="text-xs border border-pink-500 text-pink-500 px-3 py-1 rounded hover:bg-pink-500 hover:text-white transition">Add New</button></div>
                  <div class="overflow-x-auto">
                     <table class="w-full text-xs text-left">
                        <tr class="text-[var(--text-sec)] border-b border-[var(--glass-border)]"><th class="pb-2">Username</th><th>Name</th><th>Role</th><th>Status</th><th>Action</th></tr>
                        <tr v-for="u in db.adminUsers" class="border-b border-[var(--glass-border)] hover:bg-[var(--glass-border)]">
                           <td class="py-2">{{ u.Username }}</td><td>{{ u.Name }}</td><td>{{ u.Role }}</td>
                           <td><span :class="u.Status==='Active'?'text-green-400':'text-red-400'">{{ u.Status }}</span></td>
                           <td>
                              <button v-if="u.Username!=='admin'" @click="openModal('user', 'edit', u)" class="text-blue-400 mr-2"><i class="fa-solid fa-pen"></i></button>
                              <button v-if="u.Username!=='admin'" @click="deleteItem('manageUser', u.rowIndex)" class="text-red-400"><i class="fa-solid fa-trash"></i></button>
                           </td>
                        </tr>
                     </table>
                  </div>
               </div>
               
               <div class="glass-card p-6">
                  <h3 class="font-bold mb-4 text-yellow-500"><i class="fa-solid fa-warehouse mr-2"></i> Inventory Generator</h3>
                  <p class="text-xs text-[var(--text-sec)] mb-4">Automatically generate location codes (e.g. A-1 | R-1 : C-1)</p>
                  <div class="space-y-3">
                     <div class="flex gap-2">
                        <div class="flex-1"><label class="text-xs text-[var(--text-sec)]">Prefix</label><input v-model="inv.prefix" placeholder="A" class="glass-input w-full p-2 rounded"></div>
                        <div class="flex-1"><label class="text-xs text-[var(--text-sec)]">Almirahs</label><input v-model="inv.almirahCount" type="number" class="glass-input w-full p-2 rounded"></div>
                     </div>
                     <div class="flex gap-2">
                        <div class="flex-1"><label class="text-xs text-[var(--text-sec)]">Rows</label><input v-model="inv.rows" type="number" class="glass-input w-full p-2 rounded"></div>
                        <div class="flex-1"><label class="text-xs text-[var(--text-sec)]">Cols</label><input v-model="inv.cols" type="number" class="glass-input w-full p-2 rounded"></div>
                     </div>
                     <button @click="generateInventory" class="w-full py-2 bg-yellow-600 hover:bg-yellow-500 rounded font-bold text-white shadow">Generate Locations</button>
                  </div>
               </div>
            </div>
         </div>
      </main>

      <transition name="slide">
         <div v-if="previewUrl" class="fixed top-0 right-0 h-full w-full md:w-[600px] glass-card border-l border-[var(--glass-border)] z-[80] shadow-2xl flex flex-col bg-[var(--panel-bg)]">
            <div class="p-4 border-b border-[var(--glass-border)] flex justify-between items-center">
               <h3 class="font-bold">File Preview</h3>
               <div class="flex gap-2">
                  <a :href="previewUrl" target="_blank" download class="p-2 bg-blue-500 rounded text-white text-xs font-bold hover:bg-blue-600">Download</a>
                  <button @click="previewUrl=null" class="p-2 bg-gray-500/20 rounded hover:bg-red-500 hover:text-white"><i class="fa-solid fa-xmark"></i></button>
               </div>
            </div>
            <div class="flex-1 bg-black/20 p-4 overflow-hidden flex items-center justify-center">
               <iframe :src="previewUrl" class="w-full h-full rounded-lg border-none bg-white"></iframe>
            </div>
         </div>
      </transition>

      <div v-if="qrModal.show" class="fixed inset-0 bg-black/90 z-[70] flex items-center justify-center p-4">
         <div class="glass-card p-8 text-center max-w-sm w-full relative">
            <button @click="qrModal.show=false" class="absolute top-4 right-4 text-gray-400 hover:text-white"><i class="fa-solid fa-xmark"></i></button>
            <h3 class="text-xl font-bold mb-4">QR Code</h3>
            <div class="bg-white p-4 rounded-xl inline-block mb-6">
               <canvas id="qrCanvas"></canvas>
            </div>
            <div class="text-left bg-[var(--glass-border)] p-4 rounded-xl mb-6 text-sm space-y-1">
               <p><span class="text-[var(--text-sec)]">File:</span> <span class="font-bold">{{ qrModal.file.Name }}</span></p>
               <p><span class="text-[var(--text-sec)]">No:</span> <span class="font-bold font-mono">{{ qrModal.file.FileNo }}</span></p>
               <p><span class="text-[var(--text-sec)]">Loc:</span> <span class="text-purple-400">{{ qrModal.file.Location }}</span></p>
            </div>
            <button @click="downloadQR" class="w-full py-3 btn-gradient rounded-xl font-bold shadow-lg"><i class="fa-solid fa-download mr-2"></i> Download HD PNG</button>
         </div>
      </div>

      <div v-if="modal.show" class="fixed inset-0 bg-black/80 z-[70] flex items-center justify-center p-4 backdrop-blur-sm">
         <div class="glass-card p-8 w-full max-w-2xl max-h-[90vh] overflow-y-auto slide-up">
            <h3 class="text-xl font-bold mb-6 capitalize border-b border-[var(--glass-border)] pb-4">{{ modal.mode }} {{ modal.type }}</h3>
            
            <div v-if="modal.type==='cat'" class="space-y-4">
               <label class="text-xs font-bold text-[var(--text-sec)]">CATEGORY NAME</label>
               <input v-model="forms.cat.Name" class="glass-input w-full p-3 rounded-xl">
               <label class="text-xs font-bold text-[var(--text-sec)]">ICON CLASS (FontAwesome)</label>
               <input v-model="forms.cat.Icon" placeholder="fa-solid fa-folder" class="glass-input w-full p-3 rounded-xl">
            </div>

            <div v-if="modal.type==='con'" class="space-y-4">
               <div class="grid md:grid-cols-2 gap-4">
                  <div><label class="text-xs font-bold text-[var(--text-sec)]">FIRM NAME</label><input v-model="forms.con.FirmName" class="glass-input w-full p-3 rounded-xl"></div>
                  <div><label class="text-xs font-bold text-[var(--text-sec)]">AGREEMENT NO</label><input v-model="forms.con.AgreementNo" class="glass-input w-full p-3 rounded-xl"></div>
               </div>
               <div class="grid md:grid-cols-2 gap-4">
                  <div><label class="text-xs font-bold text-[var(--text-sec)]">START DATE</label><input type="date" v-model="forms.con.StartDate" class="glass-input w-full p-3 rounded-xl"></div>
                  <div><label class="text-xs font-bold text-[var(--text-sec)]">END DATE</label><input type="date" v-model="forms.con.EndDate" class="glass-input w-full p-3 rounded-xl"></div>
               </div>
               <textarea v-model="forms.con.Description" placeholder="Contract Details..." class="glass-input w-full p-3 rounded-xl h-24"></textarea>
               <select v-model="forms.con.Status" class="glass-input w-full p-3 rounded-xl"><option>Active</option><option>Expired</option></select>
            </div>

            <div v-if="modal.type==='file'" class="space-y-4">
               <div v-if="forms.file.ParentFileID" class="p-3 bg-purple-500/10 border border-purple-500/30 rounded-xl text-xs text-purple-300 mb-2">Creating Sub-File</div>
               
               <div class="grid md:grid-cols-2 gap-4">
                  <div><label class="text-xs font-bold text-[var(--text-sec)]">FILE NO</label><input v-model="forms.file.FileNo" class="glass-input w-full p-3 rounded-xl"></div>
                  <div><label class="text-xs font-bold text-[var(--text-sec)]">SUBJECT / NAME</label><input v-model="forms.file.Name" class="glass-input w-full p-3 rounded-xl"></div>
               </div>

               <div class="p-4 bg-[var(--glass-border)] rounded-xl border border-[var(--glass-border)]">
                  <label class="text-xs font-bold text-[var(--text-sec)] block mb-2">PHYSICAL LOCATION</label>
                  <div class="grid grid-cols-3 gap-2">
                     <select v-model="locPicker.rack" class="glass-input w-full p-2 rounded-lg text-xs">
                        <option value="">Select Rack</option>
                        <option v-for="r in uniqueRacks" :value="r">{{ r }}</option>
                     </select>
                     <select v-model="locPicker.row" class="glass-input w-full p-2 rounded-lg text-xs" :disabled="!locPicker.rack">
                        <option value="">Row</option>
                        <option v-for="r in uniqueRows" :value="r">Row {{ r }}</option>
                     </select>
                     <select v-model="locPicker.col" class="glass-input w-full p-2 rounded-lg text-xs" :disabled="!locPicker.row">
                        <option value="">Col</option>
                        <option v-for="c in uniqueCols" :value="c">Col {{ c }}</option>
                     </select>
                  </div>
                  <div class="text-xs text-right mt-1 text-purple-400 font-mono">{{ compiledLocation }}</div>
               </div>

               <div class="grid md:grid-cols-2 gap-4">
                  <div>
                     <label class="text-xs font-bold text-[var(--text-sec)]">FILE TYPE</label>
                     <select v-model="forms.file.Type" class="glass-input w-full p-3 rounded-xl" :disabled="!!forms.file.ParentFileID">
                        <option>Pink File</option><option>Brown File</option><option>White Backing</option><option>Register</option><option>Sub-File</option><option>Custom</option>
                     </select>
                  </div>
                  <div>
                     <label class="text-xs font-bold text-[var(--text-sec)]">PAGES</label>
                     <input v-model="forms.file.PageCount" type="number" class="glass-input w-full p-3 rounded-xl">
                  </div>
               </div>
               <textarea v-model="forms.file.Description" placeholder="Description..." class="glass-input w-full p-3 rounded-xl h-20"></textarea>
               
               <div v-if="modal.mode==='create'" class="p-6 border-2 border-dashed border-[var(--glass-border)] rounded-xl text-center hover:bg-[var(--glass-border)] cursor-pointer relative transition">
                  <input type="file" @change="upload" class="absolute inset-0 opacity-0 cursor-pointer">
                  <i class="fa-solid fa-cloud-arrow-up text-2xl mb-2 text-[var(--text-sec)]"></i>
                  <p class="text-[var(--text-sec)] text-xs">{{ forms.file.fileName || 'Click to Upload Document' }}</p>
               </div>
            </div>

            <div v-if="modal.type==='user'" class="space-y-4">
               <input v-model="forms.user.name" placeholder="Full Name" class="glass-input w-full p-3 rounded-xl">
               <input v-model="forms.user.username" placeholder="Username" class="glass-input w-full p-3 rounded-xl">
               <input v-model="forms.user.email" placeholder="Email" class="glass-input w-full p-3 rounded-xl">
               <input v-model="forms.user.password" placeholder="Password" class="glass-input w-full p-3 rounded-xl">
               <select v-model="forms.user.role" class="glass-input w-full p-3 rounded-xl"><option>Manager</option><option>Admin</option></select>
            </div>

            <div class="flex justify-end gap-4 mt-8 pt-4 border-t border-[var(--glass-border)]">
               <button @click="modal.show=false" class="px-6 py-2 rounded-xl text-[var(--text-sec)] hover:bg-[var(--glass-border)] transition">Cancel</button>
               <button @click="saveItem" class="px-8 py-2 btn-gradient rounded-xl font-bold shadow-lg">Save</button>
            </div>
         </div>
      </div>

    </div>
  </div>

  <script>
    /** CONFIG */
    const API_URL = "https://fms1.clickworld.workers.dev"; 

    const { createApp } = Vue;
    createApp({
      data() {
        return {
          isDark: true, loading: false, notify: null, page: 'login', view: 'home', authForm: { email: '', password: '' }, user: null,
          search: '',
          db: { categories: [], contracts: [], files: [], locations: [], adminUsers: [] },
          selectedCat: null, selectedCon: null,
          modal: { show: false, type: '', mode: '' },
          forms: { cat: {}, con: {}, file: {}, user: {} },
          inv: { prefix: 'A', almirahCount: 1, rows: 5, cols: 5 },
          // Location Picker State
          locPicker: { rack: '', row: '', col: '' },
          previewUrl: null,
          qrModal: { show: false, file: {} }
        }
      },
      computed: {
        // AI SEARCH ALGORITHM
        filteredContracts() {
           const q = this.search.toLowerCase();
           let list = this.db.contracts.filter(c => c.CatID === this.selectedCat?.CatID);
           if(q && !this.selectedCat) { // Global Search Logic
              // If global search, return everything matching
              return this.db.contracts.filter(c => c.FirmName.toLowerCase().includes(q) || c.AgreementNo.toLowerCase().includes(q));
           } else if (q) {
              list = list.filter(c => c.FirmName.toLowerCase().includes(q) || c.AgreementNo.toLowerCase().includes(q));
           }
           return list;
        },
        parentFiles() {
           // AI SEARCH for Files
           const q = this.search.toLowerCase();
           let list = this.db.files.filter(f => f.ConID === this.selectedCon?.ConID && !f.ParentFileID);
           if(q && this.selectedCon) {
              // Deep Search: Name, FileNo, Desc, Type
              list = list.filter(f => 
                 f.Name.toLowerCase().includes(q) || 
                 f.FileNo.toLowerCase().includes(q) || 
                 (f.Description || '').toLowerCase().includes(q) ||
                 f.Type.toLowerCase().includes(q)
              );
           }
           return list;
        },
        
        // LOCATION PICKER COMPUTED
        uniqueRacks() {
           // Parse "A-1 | R-1 : C-1" -> Extract "A-1"
           const racks = new Set();
           this.db.locations.forEach(l => {
              const parts = l.split('|');
              if(parts[0]) racks.add(parts[0].trim());
           });
           return Array.from(racks).sort();
        },
        uniqueRows() {
           if(!this.locPicker.rack) return [];
           const rows = new Set();
           this.db.locations.forEach(l => {
              if(l.startsWith(this.locPicker.rack)) {
                 // Extract R-X
                 const match = l.match(/R-(\d+)/);
                 if(match) rows.add(parseInt(match[1]));
              }
           });
           return Array.from(rows).sort((a,b)=>a-b);
        },
        uniqueCols() {
           if(!this.locPicker.rack || !this.locPicker.row) return [];
           const cols = new Set();
           this.db.locations.forEach(l => {
              // Precise match for Rack & Row
              if(l.includes(`${this.locPicker.rack} | R-${this.locPicker.row} :`)) {
                 const match = l.match(/C-(\d+)/);
                 if(match) cols.add(parseInt(match[1]));
              }
           });
           return Array.from(cols).sort((a,b)=>a-b);
        },
        compiledLocation() {
           if(this.locPicker.rack && this.locPicker.row && this.locPicker.col) {
              return `${this.locPicker.rack} | R-${this.locPicker.row} : C-${this.locPicker.col}`;
           }
           return "No Location Selected";
        }
      },
      methods: {
        async api(action, payload={}) {
           this.loading = true;
           try {
             const res = await fetch(API_URL, { method: 'POST', body: JSON.stringify({action, payload}) });
             this.loading = false; return await res.json();
           } catch(e) { this.loading=false; this.toast("Error", "error"); return {success:false}; }
        },
        async auth() {
           const res = await this.api('login', this.authForm);
           if(res.success) { this.user = res.user; this.page='app'; this.loadData(); } else this.toast(res.msg, 'error');
        },
        async loadData() {
           const res = await this.api('getDashboard', { role: this.user.role });
           if(res.success) this.db = res.data;
        },
        navigate(v) { this.view=v; this.selectedCat=null; this.selectedCon=null; this.search=''; },
        selectCat(c) { this.selectedCat=c; },
        selectCon(c) { this.selectedCon=c; },
        getContractCount(id) { return this.db.contracts.filter(c=>c.CatID===id).length; },
        getSubFiles(parentId) { return this.db.files.filter(f => f.ParentFileID === parentId); },

        // MODALS
        openModal(type, mode, data={}) {
           this.modal = { show: true, type, mode };
           this.locPicker = { rack:'', row:'', col:'' }; // Reset Picker
           if(mode==='create') {
              if(type==='file') {
                 this.forms.file = { Type: 'Pink File', Status: 'Active', ConID: this.selectedCon?.ConID };
              }
              else if(type==='con') this.forms.con = { Status: 'Active', CatID: this.selectedCat?.CatID };
              else if(type==='cat') this.forms.cat = {};
              else if(type==='user') this.forms.user = { role: 'Manager' };
           } else {
              this.forms[type] = { ...data };
              // Reverse parse location if editing file
              if(type==='file' && data.Location) {
                 // Logic to split string back to picker can be added here, simplified for now
              }
           }
        },
        openSubFileModal(parentFile) {
           this.modal = { show: true, type: 'file', mode: 'create' };
           this.forms.file = { Type: 'Sub-File', Status: 'Active', Location: parentFile.Location, ConID: this.selectedCon.ConID, ParentFileID: parentFile.FileID };
        },

        async saveItem() {
           const type = this.modal.type;
           const action = type==='cat'?'manageCategory': type==='con'?'manageContract': type==='file'?'manageFile': 'manageUser';
           
           // Apply Location from Picker if creating file
           if(type==='file' && !this.forms.file.ParentFileID) {
              this.forms.file.Location = this.compiledLocation;
           }
           if(type==='file' && this.modal.mode==='create') this.forms.file.QR_Data = window.location.origin + window.location.pathname + `?id=FILE-${Date.now()}`;

           const res = await this.api(action, { type: this.modal.mode, data: this.forms[type], row: this.forms[type].rowIndex, user: this.user.name });
           if(res.success) { this.toast("Saved!", "success"); this.modal.show=false; this.loadData(); } else this.toast(res.msg, 'error');
        },
        async deleteItem(action, rowIndex) {
           if(!confirm("Confirm Delete?")) return;
           const res = await this.api(action, { type: 'delete', row: rowIndex });
           if(res.success) { this.toast("Deleted", "success"); this.loadData(); }
        },
        async generateInventory() {
           const res = await this.api('generateInventory', { data: this.inv });
           if(res.success) { this.toast(`Created ${res.count} Locations!`, "success"); this.loadData(); }
        },

        upload(e) { const f=e.target.files[0]; const r=new FileReader(); r.onload=ev=>{this.forms.file.fileData=ev.target.result.split(',')[1]; this.forms.file.mime=f.type; this.forms.file.fileName=f.name;}; r.readAsDataURL(f); },
        
        // PREVIEW & QR
        openPreview(f) { if(f.AttachmentURL) this.previewUrl = f.AttachmentURL; else this.toast("No document attached", "error"); },
        openQRModal(f) {
           this.qrModal = { show: true, file: f };
           this.$nextTick(() => {
              const qr = new QRious({ element: document.getElementById('qrCanvas'), value: f.QR_Data, size: 250 });
           });
        },
        downloadQR() {
           const canvas = document.getElementById('qrCanvas');
           const link = document.createElement('a');
           link.download = `QR_${this.qrModal.file.FileNo}.png`;
           link.href = canvas.toDataURL("image/png");
           link.click();
        },

        toast(msg, type) { this.notify = { msg, type }; setTimeout(()=>this.notify=null, 3000); },
        logout() { location.reload(); }
      }
    }).mount('#app');
  </script>
</body>
</html>
